# 客户合同管理系统 - 反向代理环境部署指南

## 概述

本指南适用于已有反向代理服务（如Nginx、Apache、Traefik等）的部署场景。系统将只部署应用容器，通过您现有的反向代理服务提供外部访问。

## 部署架构

```
Internet
    ↓
┌─────────────────┐
│  Your Reverse   │
│  Proxy Server   │  (Nginx/Apache/Traefik等)
│  (Port 80/443)  │
└─────────────────┘
    ↓
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   MySQL Server  │    │   Redis Server  │    │   App Container │
│   (External)    │────│   (External)    │────│   (Port 8000/   │
│                 │    │                 │    │        8080)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 前置条件

### 1. 外部服务要求
- **MySQL服务器**: 8.0+ 版本
- **Redis服务器**: 6.0+ 版本  
- **反向代理服务器**: Nginx/Apache/Traefik等

### 2. 部署服务器要求
- Docker 20.x+
- Docker Compose 2.x+
- 至少2GB内存
- 至少10GB磁盘空间

## 快速部署

### 1. 下载部署文件

```bash
# 创建部署目录
mkdir -p /opt/contract-ledger
cd /opt/contract-ledger

# 下载部署文件
wget https://raw.githubusercontent.com/bluewatercg/ProjectContractLedger/midwayjs/deployment/docker-compose.app-only.yml
wget https://raw.githubusercontent.com/bluewatercg/ProjectContractLedger/midwayjs/deployment/.env.app-only.template
```

### 2. 配置环境变量

```bash
# 复制配置模板
cp .env.app-only.template .env.app-only

# 编辑配置文件
nano .env.app-only
```

**关键配置项**：
```bash
# 应用端口配置
APP_HTTP_PORT=8000          # 前端端口
APP_API_PORT=8080           # API端口

# MySQL配置
DB_HOST=192.168.1.100       # MySQL服务器IP
DB_USERNAME=contract_user   # 数据库用户名
DB_PASSWORD=your_password   # 数据库密码
DB_DATABASE=contract_ledger # 数据库名称

# Redis配置
REDIS_HOST=192.168.1.101    # Redis服务器IP
REDIS_PASSWORD=your_redis_pwd # Redis密码

# JWT密钥
JWT_SECRET=your_super_secret_jwt_key_at_least_32_characters_long

# 反向代理配置
TRUST_PROXY=true            # 信任代理，获取真实客户端IP
CORS_ORIGIN=https://your-domain.com  # 设置为您的域名
```

### 3. 部署应用

```bash
# 拉取最新镜像
docker pull ghcr.io/bluewatercg/projectcontractledger:latest

# 启动应用
docker-compose -f docker-compose.app-only.yml --env-file .env.app-only up -d

# 查看状态
docker-compose -f docker-compose.app-only.yml ps
```

### 4. 验证部署

```bash
# 检查前端服务
curl http://localhost:8000

# 检查API服务
curl http://localhost:8080/api/health

# 查看日志
docker logs contract-ledger-app -f
```

## 反向代理配置

### Nginx配置示例

```nginx
# /etc/nginx/sites-available/contract-ledger
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL配置
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";

    # 前端静态文件
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # 超时配置
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # API接口
    location /api/ {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # 超时配置
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # 文件上传大小限制
        client_max_body_size 50M;
    }

    # 健康检查
    location /health {
        proxy_pass http://127.0.0.1:8000/health;
        access_log off;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### Apache配置示例

```apache
# /etc/apache2/sites-available/contract-ledger.conf
<VirtualHost *:80>
    ServerName your-domain.com
    Redirect permanent / https://your-domain.com/
</VirtualHost>

<VirtualHost *:443>
    ServerName your-domain.com
    
    # SSL配置
    SSLEngine on
    SSLCertificateFile /path/to/your/certificate.crt
    SSLCertificateKeyFile /path/to/your/private.key
    
    # 安全头
    Header always set X-Frame-Options DENY
    Header always set X-Content-Type-Options nosniff
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    
    # 启用代理模块
    ProxyPreserveHost On
    ProxyRequests Off
    
    # 前端代理
    ProxyPass /api/ http://127.0.0.1:8080/api/
    ProxyPassReverse /api/ http://127.0.0.1:8080/api/
    
    # API代理
    ProxyPass / http://127.0.0.1:8000/
    ProxyPassReverse / http://127.0.0.1:8000/
    
    # 设置代理头
    ProxyPassReverse / http://127.0.0.1:8000/
    ProxyPassReverseRewrite / http://127.0.0.1:8000/
</VirtualHost>
```

### Traefik配置示例

```yaml
# docker-compose.yml 中的 labels 配置
services:
  app:
    # ... 其他配置
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.contract-ledger.rule=Host(`your-domain.com`)"
      - "traefik.http.routers.contract-ledger.entrypoints=websecure"
      - "traefik.http.routers.contract-ledger.tls.certresolver=letsencrypt"
      
      # 前端服务
      - "traefik.http.services.contract-ledger-frontend.loadbalancer.server.port=8000"
      - "traefik.http.routers.contract-ledger-frontend.rule=Host(`your-domain.com`)"
      - "traefik.http.routers.contract-ledger-frontend.service=contract-ledger-frontend"
      
      # API服务
      - "traefik.http.services.contract-ledger-api.loadbalancer.server.port=8080"
      - "traefik.http.routers.contract-ledger-api.rule=Host(`your-domain.com`) && PathPrefix(`/api`)"
      - "traefik.http.routers.contract-ledger-api.service=contract-ledger-api"
```

## 端口配置说明

### 默认端口映射
- **8000**: 前端HTTP服务（Vue.js应用）
- **8080**: 后端API服务（Midway.js应用）

### 自定义端口
如果需要使用其他端口，修改 `.env.app-only` 文件：
```bash
# 使用自定义端口
APP_HTTP_PORT=9000    # 前端端口改为9000
APP_API_PORT=9080     # API端口改为9080
```

然后相应地更新反向代理配置中的端口。

## 网络配置

### 桥接网络模式（默认）
```bash
NETWORK_MODE=bridge
```
应用运行在Docker网络中，通过端口映射提供服务。

### 主机网络模式
```bash
NETWORK_MODE=host
```
应用直接使用主机网络，性能更好但端口冲突风险更高。

## 监控和维护

### 1. 健康检查

```bash
# 应用健康检查
curl http://localhost:8000/health
curl http://localhost:8080/api/health

# 通过反向代理检查
curl https://your-domain.com/health
curl https://your-domain.com/api/health
```

### 2. 日志管理

```bash
# 查看应用日志
docker logs contract-ledger-app -f --tail 100

# 查看反向代理日志
# Nginx
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# Apache
tail -f /var/log/apache2/access.log
tail -f /var/log/apache2/error.log
```

### 3. 性能监控

```bash
# 查看容器资源使用
docker stats contract-ledger-app

# 查看系统负载
htop
iostat -x 1
```

## 故障排除

### 1. 应用无法访问
```bash
# 检查容器状态
docker ps | grep contract-ledger

# 检查端口监听
netstat -tlnp | grep -E "(8000|8080)"

# 检查防火墙
ufw status
iptables -L
```

### 2. 反向代理502错误
```bash
# 检查上游服务
curl http://localhost:8000
curl http://localhost:8080/api/health

# 检查反向代理配置
nginx -t
apache2ctl configtest
```

### 3. 数据库连接问题
```bash
# 进入容器检查
docker exec -it contract-ledger-app bash
ping $DB_HOST
telnet $DB_HOST 3306
```

## 安全建议

1. **反向代理安全**：
   - 启用SSL/TLS
   - 配置安全头
   - 限制请求大小
   - 设置访问日志

2. **网络安全**：
   - 使用防火墙限制端口访问
   - 配置VPN或专用网络
   - 定期更新系统和应用

3. **应用安全**：
   - 设置强JWT密钥
   - 配置CORS策略
   - 启用访问日志
   - 定期备份数据

## 更新和维护

### 更新应用
```bash
# 拉取最新镜像
docker pull ghcr.io/bluewatercg/projectcontractledger:latest

# 重启应用
docker-compose -f docker-compose.app-only.yml --env-file .env.app-only down
docker-compose -f docker-compose.app-only.yml --env-file .env.app-only up -d
```

### 备份数据
```bash
# 备份数据库
mysqldump -h $DB_HOST -u $DB_USERNAME -p$DB_PASSWORD $DB_DATABASE > backup.sql

# 备份应用数据
docker cp contract-ledger-app:/app/uploads ./uploads-backup
```

这样配置后，您的应用将完美集成到现有的反向代理环境中！
