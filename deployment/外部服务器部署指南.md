# 客户合同管理系统 - 外部服务器部署指南

## 概述

本指南适用于已有MySQL和Redis服务器的部署场景。系统将只部署应用容器，连接到您现有的数据库和缓存服务器。

## 前置条件

### 1. 外部服务器要求

#### MySQL服务器
- **版本**: MySQL 8.0 或更高版本
- **网络**: 确保部署服务器可以访问MySQL服务器
- **权限**: 需要创建数据库和用户的权限

#### Redis服务器
- **版本**: Redis 6.0 或更高版本
- **网络**: 确保部署服务器可以访问Redis服务器
- **配置**: 建议启用持久化

### 2. 部署服务器要求
- Docker 20.x 或更高版本
- Docker Compose 2.x 或更高版本
- 至少2GB可用内存
- 至少10GB可用磁盘空间

## 数据库准备

### 1. 创建MySQL数据库和用户

```sql
-- 连接到MySQL服务器
mysql -u root -p

-- 创建数据库
CREATE DATABASE contract_ledger CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户（替换为您的实际密码）
CREATE USER 'contract_user'@'%' IDENTIFIED BY 'your_secure_password';

-- 授权
GRANT ALL PRIVILEGES ON contract_ledger.* TO 'contract_user'@'%';
FLUSH PRIVILEGES;

-- 验证连接
SHOW DATABASES;
```

### 2. 网络连接测试

```bash
# 从部署服务器测试MySQL连接
mysql -h 192.168.1.100 -P 3306 -u contract_user -p contract_ledger

# 测试Redis连接
redis-cli -h 192.168.1.101 -p 6379 ping
```

## 部署步骤

### 1. 准备部署目录

```bash
# 创建部署目录
mkdir -p /opt/contract-ledger
cd /opt/contract-ledger

# 下载部署文件（或从项目中复制）
wget https://raw.githubusercontent.com/bluewatercg/ProjectContractLedger/midwayjs/deployment/docker-compose.external-services.yml
wget https://raw.githubusercontent.com/bluewatercg/ProjectContractLedger/midwayjs/deployment/.env.external-services.template
```

### 2. 配置环境变量

```bash
# 复制环境变量模板
cp .env.external-services.template .env.external-services

# 编辑配置文件
nano .env.external-services
```

**重要配置项**：
```bash
# MySQL配置
DB_HOST=192.168.1.100          # 您的MySQL服务器IP
DB_PORT=3306                   # MySQL端口
DB_USERNAME=contract_user      # 数据库用户名
DB_PASSWORD=your_secure_password # 数据库密码
DB_DATABASE=contract_ledger    # 数据库名称

# Redis配置
REDIS_HOST=192.168.1.101       # 您的Redis服务器IP
REDIS_PORT=6379                # Redis端口
REDIS_PASSWORD=your_redis_password # Redis密码（如果有）

# JWT密钥（必须设置）
JWT_SECRET=your_super_secret_jwt_key_at_least_32_characters_long
```

### 3. 部署应用

```bash
# 拉取最新镜像
docker pull ghcr.io/bluewatercg/projectcontractledger:latest

# 启动服务
docker-compose -f docker-compose.external-services.yml --env-file .env.external-services up -d

# 查看服务状态
docker-compose -f docker-compose.external-services.yml ps
```

### 4. 验证部署

```bash
# 检查应用健康状态
curl http://localhost/health

# 检查API状态
curl http://localhost:8080/api/health

# 查看应用日志
docker logs contract-ledger-app -f
```

## 高级配置

### 1. 使用Nginx反向代理

如果需要SSL终端或负载均衡，可以启用Nginx服务：

```bash
# 创建Nginx配置目录
mkdir -p nginx/conf.d ssl

# 创建Nginx配置文件
cat > nginx/conf.d/default.conf << 'EOF'
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    # 前端静态文件
    location / {
        proxy_pass http://app:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API接口
    location /api/ {
        proxy_pass http://app:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
EOF
```

### 2. 数据库迁移

首次部署时，需要运行数据库迁移：

```bash
# 进入应用容器
docker exec -it contract-ledger-app bash

# 运行数据库迁移（如果应用支持）
npm run migration:run

# 或者手动导入初始数据
mysql -h $DB_HOST -u $DB_USERNAME -p$DB_PASSWORD $DB_DATABASE < /app/database/init.sql
```

## 监控和维护

### 1. 日志管理

```bash
# 查看应用日志
docker logs contract-ledger-app -f --tail 100

# 查看系统资源使用
docker stats contract-ledger-app

# 清理日志（定期执行）
docker system prune -f
```

### 2. 备份策略

```bash
# 数据库备份脚本
cat > backup-db.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/opt/backups"
mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -h $DB_HOST -u $DB_USERNAME -p$DB_PASSWORD $DB_DATABASE > $BACKUP_DIR/contract_ledger_$DATE.sql
gzip $BACKUP_DIR/contract_ledger_$DATE.sql

# 清理旧备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete
EOF

chmod +x backup-db.sh

# 设置定时备份
crontab -e
# 添加：0 2 * * * /opt/contract-ledger/backup-db.sh
```

### 3. 更新应用

```bash
# 更新脚本
cat > update.sh << 'EOF'
#!/bin/bash
echo "更新应用..."

# 备份数据库
./backup-db.sh

# 拉取最新镜像
docker pull ghcr.io/bluewatercg/projectcontractledger:latest

# 重启服务
docker-compose -f docker-compose.external-services.yml --env-file .env.external-services down
docker-compose -f docker-compose.external-services.yml --env-file .env.external-services up -d

echo "更新完成！"
EOF

chmod +x update.sh
```

## 故障排除

### 1. 数据库连接问题

```bash
# 检查网络连通性
ping 192.168.1.100

# 检查端口是否开放
telnet 192.168.1.100 3306

# 检查MySQL用户权限
mysql -h 192.168.1.100 -u contract_user -p -e "SHOW GRANTS;"
```

### 2. Redis连接问题

```bash
# 检查Redis连接
redis-cli -h 192.168.1.101 -p 6379 ping

# 检查Redis配置
redis-cli -h 192.168.1.101 -p 6379 CONFIG GET "*"
```

### 3. 应用启动问题

```bash
# 查看详细日志
docker logs contract-ledger-app --details

# 检查环境变量
docker exec contract-ledger-app env | grep -E "(DB_|REDIS_|JWT_)"

# 进入容器调试
docker exec -it contract-ledger-app bash
```

## 安全建议

### 1. 网络安全
- 使用防火墙限制数据库和Redis的访问
- 配置VPN或专用网络连接
- 定期更新服务器和应用

### 2. 数据库安全
- 使用强密码
- 定期备份数据
- 启用MySQL的SSL连接
- 限制数据库用户权限

### 3. Redis安全
- 设置Redis密码
- 禁用危险命令
- 配置适当的内存限制

## 性能优化

### 1. 数据库优化
```sql
-- 优化MySQL配置
SET GLOBAL innodb_buffer_pool_size = 1073741824; -- 1GB
SET GLOBAL max_connections = 200;
SET GLOBAL query_cache_size = 67108864; -- 64MB
```

### 2. Redis优化
```bash
# Redis配置优化
redis-cli CONFIG SET maxmemory 512mb
redis-cli CONFIG SET maxmemory-policy allkeys-lru
```

### 3. 应用优化
- 调整数据库连接池大小
- 配置适当的缓存策略
- 监控应用性能指标

## 联系支持

如遇到部署问题，请：
1. 检查日志文件
2. 验证网络连接
3. 确认配置文件
4. 联系技术支持团队
