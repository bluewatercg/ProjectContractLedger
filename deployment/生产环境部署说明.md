# 客户合同管理系统 - 生产环境部署说明

## 概述

本文档详细说明如何将客户合同管理系统部署到生产环境。系统采用Docker容器化部署，支持自动化CI/CD流程。

## 系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Nginx Proxy   │    │   Frontend      │    │   Backend API   │
│   (Port 80/443) │────│   (Vue.js)      │────│   (Midway.js)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                       │
                                              ┌─────────────────┐
                                              │   MySQL DB      │
                                              │   (Port 3306)   │
                                              └─────────────────┘
```

## 部署方式

### 方式一：GitHub Actions自动部署（推荐）

#### 1. 自动构建流程

当代码推送到`main`、`master`或`midwayjs`分支时，GitHub Actions会自动：

1. 运行代码检查和测试
2. 构建Docker镜像
3. 推送镜像到GitHub Container Registry
4. 触发部署流程

#### 2. 镜像地址

```bash
# 最新版本
ghcr.io/bluewatercg/projectcontractledger:latest

# 特定分支版本
ghcr.io/bluewatercg/projectcontractledger:midwayjs

# 特定提交版本
ghcr.io/bluewatercg/projectcontractledger:midwayjs-<commit-sha>
```

#### 3. 部署命令

```bash
# 拉取最新镜像
docker pull ghcr.io/bluewatercg/projectcontractledger:latest

# 停止旧容器
docker stop contract-ledger || true
docker rm contract-ledger || true

# 启动新容器
docker run -d \
  --name contract-ledger \
  -p 80:80 \
  -p 8080:8080 \
  -e NODE_ENV=production \
  -e DB_HOST=your-db-host \
  -e DB_PORT=3306 \
  -e DB_USERNAME=your-db-user \
  -e DB_PASSWORD=your-db-password \
  -e DB_DATABASE=your-db-name \
  -e JWT_SECRET=your-jwt-secret \
  --restart unless-stopped \
  ghcr.io/bluewatercg/projectcontractledger:latest
```

### 方式二：Docker Compose部署

#### 1. 创建部署目录

```bash
mkdir -p /opt/contract-ledger
cd /opt/contract-ledger
```

#### 2. 创建docker-compose.prod.yml

```yaml
version: '3.8'

services:
  app:
    image: ghcr.io/bluewatercg/projectcontractledger:latest
    container_name: contract-ledger-app
    ports:
      - "80:80"
      - "8080:8080"
    environment:
      - NODE_ENV=production
      - DB_HOST=db
      - DB_PORT=3306
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE=${DB_DATABASE}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - db
    restart: unless-stopped
    networks:
      - contract-ledger-network

  db:
    image: mysql:8.0
    container_name: contract-ledger-db
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${DB_DATABASE}
      - MYSQL_USER=${DB_USERNAME}
      - MYSQL_PASSWORD=${DB_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
      - ./database/scripts:/docker-entrypoint-initdb.d
    ports:
      - "3306:3306"
    restart: unless-stopped
    networks:
      - contract-ledger-network

volumes:
  db_data:

networks:
  contract-ledger-network:
    driver: bridge
```

#### 3. 创建环境变量文件

```bash
# 创建.env文件
cat > .env << EOF
# 数据库配置
DB_USERNAME=contract_user
DB_PASSWORD=your_secure_password
DB_DATABASE=contract_ledger
MYSQL_ROOT_PASSWORD=your_root_password

# JWT密钥
JWT_SECRET=your_jwt_secret_key

# 其他配置
NODE_ENV=production
EOF
```

#### 4. 启动服务

```bash
# 启动所有服务
docker-compose -f docker-compose.prod.yml up -d

# 查看服务状态
docker-compose -f docker-compose.prod.yml ps

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f
```

## 环境配置

### 1. 必需的环境变量

```bash
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=contract_user
DB_PASSWORD=secure_password
DB_DATABASE=contract_ledger

# JWT配置
JWT_SECRET=your-super-secret-jwt-key
JWT_EXPIRES_IN=7d

# 应用配置
NODE_ENV=production
PORT=8080

# 文件存储配置（可选）
MINIO_ENDPOINT=https://oss.huijg.cn
MINIO_ACCESS_KEY=your-access-key
MINIO_SECRET_KEY=your-secret-key
MINIO_BUCKET=qiji/ProjectContractLedger
```

### 2. 数据库初始化

```bash
# 创建数据库
mysql -u root -p -e "CREATE DATABASE contract_ledger CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 创建用户
mysql -u root -p -e "CREATE USER 'contract_user'@'%' IDENTIFIED BY 'secure_password';"
mysql -u root -p -e "GRANT ALL PRIVILEGES ON contract_ledger.* TO 'contract_user'@'%';"
mysql -u root -p -e "FLUSH PRIVILEGES;"

# 导入初始数据（如果有）
mysql -u contract_user -p contract_ledger < database/scripts/init.sql
```

## 域名和SSL配置

### 1. Nginx反向代理配置

```nginx
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;

    # 前端静态文件
    location / {
        proxy_pass http://localhost:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API接口
    location /api/ {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 健康检查
    location /health {
        proxy_pass http://localhost:8080/health;
        access_log off;
    }
}
```

### 2. Let's Encrypt SSL证书

```bash
# 安装certbot
sudo apt-get update
sudo apt-get install certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d your-domain.com

# 设置自动续期
sudo crontab -e
# 添加以下行：
# 0 12 * * * /usr/bin/certbot renew --quiet
```

## 监控和日志

### 1. 健康检查

```bash
# 检查应用健康状态
curl http://localhost/health

# 检查API状态
curl http://localhost:8080/api/health
```

### 2. 日志管理

```bash
# 查看应用日志
docker logs contract-ledger-app -f

# 查看数据库日志
docker logs contract-ledger-db -f

# 使用docker-compose查看日志
docker-compose -f docker-compose.prod.yml logs -f app
```

### 3. 性能监控

```bash
# 查看容器资源使用情况
docker stats

# 查看系统资源
htop
df -h
free -h
```

## 备份和恢复

### 1. 数据库备份

```bash
# 创建备份脚本
cat > backup.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/opt/backups"
mkdir -p $BACKUP_DIR

# 备份数据库
docker exec contract-ledger-db mysqldump -u root -p$MYSQL_ROOT_PASSWORD contract_ledger > $BACKUP_DIR/contract_ledger_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/contract_ledger_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "Backup completed: contract_ledger_$DATE.sql.gz"
EOF

chmod +x backup.sh

# 设置定时备份
crontab -e
# 添加：每天凌晨2点备份
# 0 2 * * * /opt/contract-ledger/backup.sh
```

### 2. 数据恢复

```bash
# 恢复数据库
gunzip -c /opt/backups/contract_ledger_YYYYMMDD_HHMMSS.sql.gz | \
docker exec -i contract-ledger-db mysql -u root -p$MYSQL_ROOT_PASSWORD contract_ledger
```

## 更新部署

### 1. 自动更新（推荐）

```bash
# 创建更新脚本
cat > update.sh << 'EOF'
#!/bin/bash
echo "Updating Contract Ledger System..."

# 拉取最新镜像
docker pull ghcr.io/bluewatercg/projectcontractledger:latest

# 使用docker-compose更新
docker-compose -f docker-compose.prod.yml pull
docker-compose -f docker-compose.prod.yml up -d

echo "Update completed!"
EOF

chmod +x update.sh
```

### 2. 手动更新

```bash
# 停止服务
docker-compose -f docker-compose.prod.yml down

# 拉取最新镜像
docker-compose -f docker-compose.prod.yml pull

# 启动服务
docker-compose -f docker-compose.prod.yml up -d
```

## 故障排除

### 1. 常见问题

#### 应用无法启动
```bash
# 检查日志
docker logs contract-ledger-app

# 检查环境变量
docker exec contract-ledger-app env | grep -E "(DB_|JWT_|NODE_)"
```

#### 数据库连接失败
```bash
# 检查数据库状态
docker exec contract-ledger-db mysql -u root -p -e "SHOW DATABASES;"

# 检查网络连接
docker exec contract-ledger-app ping db
```

#### 内存不足
```bash
# 检查系统资源
free -h
df -h

# 清理Docker资源
docker system prune -a
```

### 2. 紧急恢复

```bash
# 快速回滚到上一个版本
docker-compose -f docker-compose.prod.yml down
docker pull ghcr.io/bluewatercg/projectcontractledger:previous-tag
# 修改docker-compose.yml中的镜像标签
docker-compose -f docker-compose.prod.yml up -d
```

## 安全建议

1. **定期更新**: 保持系统和依赖包的最新版本
2. **强密码**: 使用强密码和定期更换
3. **防火墙**: 配置适当的防火墙规则
4. **SSL/TLS**: 使用HTTPS加密传输
5. **备份**: 定期备份数据和配置
6. **监控**: 设置监控和告警系统
7. **日志**: 保留足够的日志用于审计

## 联系支持

如遇到部署问题，请：
1. 查看应用日志
2. 检查系统资源
3. 参考故障排除章节
4. 联系技术支持团队
