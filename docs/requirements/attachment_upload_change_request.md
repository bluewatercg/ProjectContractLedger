# 需求变更说明：合同与发票附件上传功能

## 1. 变更目的

为满足业务需求，实现合同和发票的附件上传功能，以便用户能够将相关文档（如合同扫描件、发票图片等）与对应的合同或发票记录进行关联和管理。此功能将提升系统的数据完整性、可追溯性，并简化业务流程中的文档归档工作。

## 2. 变更描述

在现有合同管理和发票管理模块中，增加附件上传、存储、查看和下载功能。

*   **合同模块：** 允许用户为每份合同上传一个或多个附件。
*   **发票模块：** 允许用户为每张发票上传一个或多个附件。

## 3. 技术方案

### 3.1 附件存储方案

#### 3.1.1 第一阶段：本地存储（初期实现）

*   **技术选型：** 基于 Midway.js 框架的 `@midwayjs/upload` 组件。
*   **存储路径：** 文件将存储在后端服务内部的特定目录，例如 `/app/uploads`。
*   **后端实现：**
    *   新增 `AttachmentController`，提供文件上传 API。
    *   API 负责接收文件、进行类型和大小校验、保存文件到本地，并将文件路径等元数据存储到数据库。
*   **数据库变更：**
    *   在 `contract` 表和 `invoice` 表中新增字段，用于存储附件的文件路径（例如：`attachment_path`，类型为 `VARCHAR` 或 `JSON`，取决于是否支持多附件）。
*   **前端实现：**
    *   集成文件上传组件，调用后端上传 API。
    *   在合同和发票详情页展示已上传附件，并提供下载/预览功能。

#### 3.1.2 第二阶段：云存储（未来扩展）

*   **目的：** 应对系统规模扩大、高可用性、数据持久性及全球分发需求。
*   **技术选型：** 考虑集成阿里云 OSS、腾讯云 COS 或 AWS S3 等云存储服务。
*   **迁移方式：** 修改后端上传逻辑，将文件直接上传至云存储，数据库中存储云存储返回的 URL。

### 3.2 附件类型选择

*   **PDF (Portable Document Format)：**
    *   **优势：** 保持原始格式和布局，适用于正式文档、扫描件。
    *   **建议：** 作为合同和发票附件的首选格式。
*   **图片 (JPEG, PNG等)：**
    *   **优势：** 适用于扫描件、截图，便于在线预览。
    *   **建议：** 作为辅助附件类型。
*   **文件类型控制：** 后端将通过文件类型白名单严格控制，只允许 PDF 和常用图片格式上传。

### 3.3 GitHub Actions 自动构建与部署

*   **镜像构建：** GitHub Actions 工作流将继续负责构建后端 (`apps/backend`) 和前端 (`apps/frontend`) 的 Docker 镜像。
*   **持久化存储：**
    *   **关键：** 对于本地存储方案，上传的附件将保存在 Docker 容器内部的 `/app/uploads` 目录。为确保数据持久性，部署时必须配置 Docker 卷（Volume）挂载。
    *   **实现：** 在 `deployment/docker-compose.production.yml` 或相关部署脚本中，为后端服务配置卷挂载，将宿主机的特定目录映射到容器的 `/app/uploads` 目录。
    *   **示例（`docker-compose.production.yml`）：**
        ```yaml
        services:
          backend:
            image: your-backend-image:latest
            volumes:
              - /path/on/host/for/uploads:/app/uploads # 宿主机路径需存在且有写入权限
        ```
*   **环境变量：** 附件存储路径或云存储配置等敏感信息将通过 GitHub Secrets 安全地传递给 GitHub Actions 工作流。

## 4. 影响分析

*   **后端服务：**
    *   新增文件上传 API 和逻辑。
    *   修改现有实体（`ContractEntity`, `InvoiceEntity`）。
    *   可能需要更新数据库连接配置以支持文件上传。
*   **前端应用：**
    *   新增文件上传组件。
    *   修改合同和发票详情页面，以支持附件的展示和操作。
*   **数据库：**
    *   `contract` 表和 `invoice` 表结构变更（新增附件路径字段）。
    *   需要执行数据库迁移脚本。
*   **部署流程：**
    *   GitHub Actions 工作流需要更新，以确保 Docker 卷的正确配置，实现附件数据的持久化。
*   **性能：** 大量文件上传可能对服务器存储和网络带宽造成压力，需考虑后续优化（如异步处理、文件压缩、CDN）。
*   **安全性：** 需确保文件上传的安全性，防止恶意文件上传和目录遍历攻击。

## 5. 风险评估

*   **存储空间不足：** 随着附件数量增加，本地存储空间可能耗尽。
    *   **缓解措施：** 定期监控存储使用情况；规划第二阶段云存储迁移。
*   **文件上传安全漏洞：** 未经严格校验的文件上传可能导致系统被攻击。
    *   **缓解措施：** 严格的文件类型白名单、文件大小限制、文件名规范化、病毒扫描（可选）。
*   **数据丢失：** Docker 卷配置不当可能导致附件数据在容器重启或更新后丢失。
    *   **缓解措施：** 严格测试部署脚本，确保卷挂载正确且数据持久化。
*   **网络延迟：** 大文件上传或下载可能导致用户体验下降。
    *   **缓解措施：** 优化文件传输、考虑 CDN 加速（未来）。
*   **兼容性问题：** 不同浏览器或设备对 PDF/图片预览的支持可能存在差异。
    *   **缓解措施：** 采用通用的预览方案或提供下载选项。

## 6. 审批意见

（此部分留空，供需求变更委员会填写）

---
**提交日期：** 2025年6月16日
**提交人：** [您的姓名/团队]
