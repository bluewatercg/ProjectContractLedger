<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客户管理 - 调试版本</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            font-family: monospace;
            z-index: 1000;
            border: 2px solid #374151;
        }
        .debug-panel h3 {
            color: #60a5fa;
            margin-bottom: 10px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 4px;
            border-radius: 2px;
        }
        .log-info { background: #1e40af; }
        .log-success { background: #059669; }
        .log-error { background: #dc2626; }
        .log-warning { background: #d97706; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 调试面板 -->
    <div class="debug-panel">
        <h3>🐛 调试日志</h3>
        <div id="debugLog"></div>
        <button id="clearDebugLog" class="mt-2 bg-gray-600 text-white px-2 py-1 rounded text-xs">清除</button>
    </div>

    <!-- 主要内容 -->
    <div class="min-h-screen flex">
        <!-- 侧边栏占位 -->
        <div class="w-64 bg-gray-800 text-white p-4">
            <h2 class="text-xl font-bold mb-4">合同管理系统</h2>
            <nav>
                <a href="#" class="block py-2 px-4 rounded hover:bg-gray-700">客户管理</a>
            </nav>
        </div>

        <!-- 主内容区域 -->
        <div class="flex-1 flex flex-col">
            <!-- 顶部导航栏 -->
            <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <h1 class="text-xl font-semibold text-gray-800">客户管理</h1>
                    <button id="logoutBtn" class="text-gray-600 hover:text-gray-800">
                        <i class="fas fa-sign-out-alt mr-2"></i>退出登录
                    </button>
                </div>
            </header>

            <!-- 页面内容 -->
            <main class="flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50">
                <div id="app">
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <p class="text-gray-600">正在加载客户管理页面...</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 应用脚本 -->
    <script type="module">
        // 调试日志功能
        const debugLog = document.getElementById('debugLog');
        let logCount = 0;

        function log(message, type = 'info') {
            logCount++;
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;
            
            // 限制日志条数
            if (logCount > 50) {
                debugLog.removeChild(debugLog.firstChild);
                logCount--;
            }
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // 清除调试日志
        document.getElementById('clearDebugLog').addEventListener('click', () => {
            debugLog.innerHTML = '';
            logCount = 0;
            log('调试日志已清除');
        });

        // 全局错误处理
        window.addEventListener('error', (e) => {
            log(`全局错误: ${e.message} (${e.filename}:${e.lineno})`, 'error');
        });

        window.addEventListener('unhandledrejection', (e) => {
            log(`未处理的Promise拒绝: ${e.reason}`, 'error');
        });

        // 开始初始化
        log('开始初始化客户管理页面');

        try {
            // 动态导入模块
            log('导入令牌管理器...');
            const { default: tokenManager } = await import('./assets/js/utils/tokenManager.js');
            log('令牌管理器导入成功');

            log('导入认证服务...');
            const { default: authService } = await import('./assets/js/services/auth.js');
            log('认证服务导入成功');

            log('导入客户页面组件...');
            const { default: CustomersPage } = await import('./assets/js/pages/customers.js');
            log('客户页面组件导入成功');

            // 检查登录状态
            log('检查登录状态...');
            const token = tokenManager.getToken();
            if (!token) {
                log('未找到令牌，跳转到登录页面', 'warning');
                window.location.href = 'login.html';
                return;
            }
            log('找到令牌，长度: ' + token.length);

            // 初始化令牌管理器
            log('初始化令牌管理器...');
            tokenManager.init();
            log('令牌管理器初始化完成');

            // 验证令牌有效性
            log('验证令牌有效性...');
            try {
                const isValid = await authService.validateToken();
                if (!isValid) {
                    log('令牌无效，尝试刷新...', 'warning');
                    await authService.refreshToken();
                    log('令牌刷新成功', 'success');
                } else {
                    log('令牌验证成功', 'success');
                }
            } catch (error) {
                log('令牌验证失败: ' + error.message, 'error');
                authService.logout();
                return;
            }

            // 退出登录事件
            log('绑定退出登录事件...');
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (confirm('确定要退出登录吗？')) {
                        log('用户确认退出登录');
                        authService.logout();
                    }
                });
                log('退出登录事件绑定成功');
            } else {
                log('未找到退出登录按钮', 'warning');
            }

            // 初始化客户管理页面
            log('初始化客户管理页面组件...');
            const appContainer = document.getElementById('app');
            if (appContainer) {
                log('找到应用容器，创建CustomersPage实例...');
                const customersPage = new CustomersPage(appContainer);
                log('CustomersPage实例创建成功', 'success');
                
                // 监听页面上的所有点击事件进行调试
                document.addEventListener('click', (e) => {
                    if (e.target.closest('button')) {
                        const btn = e.target.closest('button');
                        const classList = Array.from(btn.classList);
                        const dataId = btn.getAttribute('data-id');
                        log(`按钮点击: ${classList.join(' ')} (data-id: ${dataId})`);
                    }
                });
                
                log('页面初始化完成！', 'success');
            } else {
                log('未找到应用容器元素', 'error');
            }

        } catch (error) {
            log('初始化过程中发生错误: ' + error.message, 'error');
            log('错误堆栈: ' + error.stack, 'error');
        }
    </script>
</body>
</html>
