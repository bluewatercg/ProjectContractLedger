<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢æˆ·ç®¡ç† - è°ƒè¯•ç‰ˆæœ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            font-family: monospace;
            z-index: 1000;
            border: 2px solid #374151;
        }
        .debug-panel h3 {
            color: #60a5fa;
            margin-bottom: 10px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 4px;
            border-radius: 2px;
        }
        .log-info { background: #1e40af; }
        .log-success { background: #059669; }
        .log-error { background: #dc2626; }
        .log-warning { background: #d97706; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- è°ƒè¯•é¢æ¿ -->
    <div class="debug-panel">
        <h3>ğŸ› è°ƒè¯•æ—¥å¿—</h3>
        <div id="debugLog"></div>
        <button id="clearDebugLog" class="mt-2 bg-gray-600 text-white px-2 py-1 rounded text-xs">æ¸…é™¤</button>
    </div>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="min-h-screen flex">
        <!-- ä¾§è¾¹æ å ä½ -->
        <div class="w-64 bg-gray-800 text-white p-4">
            <h2 class="text-xl font-bold mb-4">åˆåŒç®¡ç†ç³»ç»Ÿ</h2>
            <nav>
                <a href="#" class="block py-2 px-4 rounded hover:bg-gray-700">å®¢æˆ·ç®¡ç†</a>
            </nav>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="flex-1 flex flex-col">
            <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
            <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <h1 class="text-xl font-semibold text-gray-800">å®¢æˆ·ç®¡ç†</h1>
                    <button id="logoutBtn" class="text-gray-600 hover:text-gray-800">
                        <i class="fas fa-sign-out-alt mr-2"></i>é€€å‡ºç™»å½•
                    </button>
                </div>
            </header>

            <!-- é¡µé¢å†…å®¹ -->
            <main class="flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50">
                <div id="app">
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <p class="text-gray-600">æ­£åœ¨åŠ è½½å®¢æˆ·ç®¡ç†é¡µé¢...</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- åº”ç”¨è„šæœ¬ -->
    <script type="module">
        // è°ƒè¯•æ—¥å¿—åŠŸèƒ½
        const debugLog = document.getElementById('debugLog');
        let logCount = 0;

        function log(message, type = 'info') {
            logCount++;
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—æ¡æ•°
            if (logCount > 50) {
                debugLog.removeChild(debugLog.firstChild);
                logCount--;
            }
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // æ¸…é™¤è°ƒè¯•æ—¥å¿—
        document.getElementById('clearDebugLog').addEventListener('click', () => {
            debugLog.innerHTML = '';
            logCount = 0;
            log('è°ƒè¯•æ—¥å¿—å·²æ¸…é™¤');
        });

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', (e) => {
            log(`å…¨å±€é”™è¯¯: ${e.message} (${e.filename}:${e.lineno})`, 'error');
        });

        window.addEventListener('unhandledrejection', (e) => {
            log(`æœªå¤„ç†çš„Promiseæ‹’ç»: ${e.reason}`, 'error');
        });

        // å¼€å§‹åˆå§‹åŒ–
        log('å¼€å§‹åˆå§‹åŒ–å®¢æˆ·ç®¡ç†é¡µé¢');

        try {
            // åŠ¨æ€å¯¼å…¥æ¨¡å—
            log('å¯¼å…¥ä»¤ç‰Œç®¡ç†å™¨...');
            const { default: tokenManager } = await import('./assets/js/utils/tokenManager.js');
            log('ä»¤ç‰Œç®¡ç†å™¨å¯¼å…¥æˆåŠŸ');

            log('å¯¼å…¥è®¤è¯æœåŠ¡...');
            const { default: authService } = await import('./assets/js/services/auth.js');
            log('è®¤è¯æœåŠ¡å¯¼å…¥æˆåŠŸ');

            log('å¯¼å…¥å®¢æˆ·é¡µé¢ç»„ä»¶...');
            const { default: CustomersPage } = await import('./assets/js/pages/customers.js');
            log('å®¢æˆ·é¡µé¢ç»„ä»¶å¯¼å…¥æˆåŠŸ');

            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            log('æ£€æŸ¥ç™»å½•çŠ¶æ€...');
            const token = tokenManager.getToken();
            if (!token) {
                log('æœªæ‰¾åˆ°ä»¤ç‰Œï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢', 'warning');
                window.location.href = 'login.html';
                return;
            }
            log('æ‰¾åˆ°ä»¤ç‰Œï¼Œé•¿åº¦: ' + token.length);

            // åˆå§‹åŒ–ä»¤ç‰Œç®¡ç†å™¨
            log('åˆå§‹åŒ–ä»¤ç‰Œç®¡ç†å™¨...');
            tokenManager.init();
            log('ä»¤ç‰Œç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');

            // éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§
            log('éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§...');
            try {
                const isValid = await authService.validateToken();
                if (!isValid) {
                    log('ä»¤ç‰Œæ— æ•ˆï¼Œå°è¯•åˆ·æ–°...', 'warning');
                    await authService.refreshToken();
                    log('ä»¤ç‰Œåˆ·æ–°æˆåŠŸ', 'success');
                } else {
                    log('ä»¤ç‰ŒéªŒè¯æˆåŠŸ', 'success');
                }
            } catch (error) {
                log('ä»¤ç‰ŒéªŒè¯å¤±è´¥: ' + error.message, 'error');
                authService.logout();
                return;
            }

            // é€€å‡ºç™»å½•äº‹ä»¶
            log('ç»‘å®šé€€å‡ºç™»å½•äº‹ä»¶...');
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                        log('ç”¨æˆ·ç¡®è®¤é€€å‡ºç™»å½•');
                        authService.logout();
                    }
                });
                log('é€€å‡ºç™»å½•äº‹ä»¶ç»‘å®šæˆåŠŸ');
            } else {
                log('æœªæ‰¾åˆ°é€€å‡ºç™»å½•æŒ‰é’®', 'warning');
            }

            // åˆå§‹åŒ–å®¢æˆ·ç®¡ç†é¡µé¢
            log('åˆå§‹åŒ–å®¢æˆ·ç®¡ç†é¡µé¢ç»„ä»¶...');
            const appContainer = document.getElementById('app');
            if (appContainer) {
                log('æ‰¾åˆ°åº”ç”¨å®¹å™¨ï¼Œåˆ›å»ºCustomersPageå®ä¾‹...');
                const customersPage = new CustomersPage(appContainer);
                log('CustomersPageå®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');
                
                // ç›‘å¬é¡µé¢ä¸Šçš„æ‰€æœ‰ç‚¹å‡»äº‹ä»¶è¿›è¡Œè°ƒè¯•
                document.addEventListener('click', (e) => {
                    if (e.target.closest('button')) {
                        const btn = e.target.closest('button');
                        const classList = Array.from(btn.classList);
                        const dataId = btn.getAttribute('data-id');
                        log(`æŒ‰é’®ç‚¹å‡»: ${classList.join(' ')} (data-id: ${dataId})`);
                    }
                });
                
                log('é¡µé¢åˆå§‹åŒ–å®Œæˆï¼', 'success');
            } else {
                log('æœªæ‰¾åˆ°åº”ç”¨å®¹å™¨å…ƒç´ ', 'error');
            }

        } catch (error) {
            log('åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            log('é”™è¯¯å †æ ˆ: ' + error.stack, 'error');
        }
    </script>
</body>
</html>
