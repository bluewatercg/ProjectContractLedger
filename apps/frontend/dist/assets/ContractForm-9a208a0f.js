/* empty css                  *//* empty css                   *//* empty css                        *//* empty css                    */import"./el-tooltip-4ed993c7.js";/* empty css                     *//* empty css               *//* empty css                   *//* empty css                     *//* empty css                        *//* empty css                 */import{d as rt,r as w,x as I,a as dt,o as ut,c as _,b as a,t as r,N as it,L as ct,w as l,e as s,M as B,h as mt,i as pt,n as g,E as _t,j as vt,R as ft,P as gt,l as c,g as y,X as ht,Y as yt,q as bt,p as wt,Z as Vt,_ as At,v as Ct,U as xt,O as kt}from"./index-94d61daa.js";import{c as q}from"./contract-8f668363.js";import{F as Dt,A as Nt,a as Y}from"./AttachmentList-ba92c06a.js";import{C as Et}from"./CustomerSelect-64654b33.js";import{_ as Mt}from"./_plugin-vue_export-helper-c27b6911.js";/* empty css                   *//* empty css                  */import"./customer-d37927e9.js";const Ft={class:"page-container"},St={class:"page-header"},Ut={class:"page-title"},Tt={class:"form-container"},It={class:"form-actions"},Bt={key:0,class:"mt-8"},qt={class:"stats-container"},Lt={class:"stat-card stat-card-blue"},Pt={class:"stat-value"},Rt={class:"stat-card stat-card-green"},zt={class:"stat-value"},$t={class:"stat-card stat-card-purple"},jt={class:"stat-value"},Ot={class:"stat-card stat-card-orange"},Yt={class:"stat-value"},Xt={class:"stat-card stat-card-red"},Zt={class:"stat-value"},Gt={key:0},Ht={class:"payment-header"},Jt={class:"payment-amount"},Kt={class:"amount-text"},Qt={class:"date-text"},Wt={class:"payment-tags"},te={key:0,class:"reference-number"},ee={class:"payment-summary"},ae={key:1,class:"text-gray-500 text-sm"},se={key:1,class:"mt-8"},oe={key:2,class:"mt-8"},ne={class:"mb-4"},le=rt({__name:"ContractForm",setup(re){const L=mt(),P=pt(),M=w(),F=w(!1),x=w(!1),u=w(null),V=w([]),S=w(!1),m=I(()=>!!P.params.id),A=I(()=>Number(P.params.id)),k=e=>{if(e==null||e==="")return 0;const t=Number(e);return isNaN(t)?0:t},C=I(()=>{var E;if(!((E=u.value)!=null&&E.invoices)||!Array.isArray(u.value.invoices))return{totalCount:0,totalAmount:0,paidAmount:0,unpaidAmount:0,uninvoicedAmount:u.value?k(u.value.total_amount):0};const e=u.value.invoices,t=k(u.value.total_amount),d=e.length,i=e.reduce((h,p)=>h+k(p.total_amount),0),b=e.reduce((h,p)=>h+U(p),0),D=i-b,N=t-i;return{totalCount:d,totalAmount:i,paidAmount:b,unpaidAmount:D,uninvoicedAmount:N}}),n=dt({customer_id:0,title:"",description:"",total_amount:0,start_date:"",end_date:"",terms:"",notes:""}),X={customer_id:[{required:!0,message:"请选择客户",trigger:"change"}],title:[{required:!0,message:"请输入合同标题",trigger:"blur"}],total_amount:[{required:!0,message:"请输入合同金额",trigger:"blur"}],start_date:[{required:!0,message:"请选择开始日期",trigger:"change"}],end_date:[{required:!0,message:"请选择结束日期",trigger:"change"}]},Z=(e,t)=>{n.customer_id=e||0,console.log("Selected customer:",t)},v=e=>new Intl.NumberFormat("zh-CN").format(e),R=e=>e?new Date(e).toLocaleDateString("zh-CN"):"-",G=e=>({draft:"info",sent:"warning",paid:"success",overdue:"danger",cancelled:"primary"})[e]||"info",H=e=>({draft:"草稿",sent:"已开票",paid:"已付款",overdue:"逾期",cancelled:"已取消"})[e]||e,J=e=>({pending:"warning",completed:"success",failed:"danger"})[e]||"info",K=e=>({pending:"待处理",completed:"已完成",failed:"失败"})[e]||e,Q=e=>({cash:"现金",bank_transfer:"银行转账",check:"支票",credit_card:"信用卡",other:"其他"})[e]||e,U=e=>!e.payments||!Array.isArray(e.payments)||e.payments.length===0?0:e.payments.filter(t=>t.status==="completed").reduce((t,d)=>t+k(d.amount),0),z=e=>{if(!e)return null;const t=new Date(e);return isNaN(t.getTime())?null:t},W=async()=>{if(m.value)try{F.value=!0;const e=await q.getContractById(A.value);if(e.success&&e.data){const t=e.data;u.value=t,Object.assign(n,{...t,start_date:z(t.start_date),end_date:z(t.end_date)})}}catch(e){console.error("Failed to fetch contract:",e),g.error("获取合同信息失败")}finally{F.value=!1}},$=e=>{if(!e)return"";const t=new Date(e);if(isNaN(t.getTime()))return"";const d=t.getFullYear(),i=String(t.getMonth()+1).padStart(2,"0"),b=String(t.getDate()).padStart(2,"0");return`${d}-${i}-${b}`},tt=async()=>{if(M.value)try{await M.value.validate(),x.value=!0;const e={...n,start_date:$(n.start_date),end_date:$(n.end_date)};let t;m.value?t=await q.updateContract(A.value,e):t=await q.createContract(e),t.success&&(g.success(m.value?"更新成功":"创建成功"),L.push("/contracts"))}catch(e){console.error("Failed to submit form:",e)}finally{x.value=!1}},et=()=>{L.go(-1)},j=async()=>{if(m.value)try{S.value=!0;const e=await Y.getContractAttachments(A.value);e.success&&e.data&&(V.value=e.data)}catch(e){console.error("Failed to fetch attachments:",e),g.error("获取附件列表失败")}finally{S.value=!1}},at=e=>{V.value.unshift(e),g.success("附件上传成功")},st=e=>{console.error("Upload error:",e),g.error("附件上传失败")},ot=async e=>{try{const t=await Y.deleteContractAttachment(A.value,e);t.success?(V.value=V.value.filter(d=>d.attachment_id!==e),g.success("附件删除成功")):g.error(t.message||"删除失败")}catch(t){console.error("Delete error:",t),g.error("删除附件失败")}};return ut(async()=>{m.value&&(await W(),await j())}),(e,t)=>{var O;const d=bt,i=wt,b=Vt,D=At,N=Ct,E=_t,h=vt,p=xt,T=kt,nt=ft,lt=gt;return c(),_("div",Ft,[a("div",St,[a("h2",Ut,r(m.value?"编辑合同":"新建合同"),1)]),a("div",Tt,[it((c(),ct(E,{ref_key:"formRef",ref:M,model:n,rules:X,"label-width":"100px"},{default:l(()=>[s(d,{label:"客户",prop:"customer_id"},{default:l(()=>[s(Et,{modelValue:n.customer_id,"onUpdate:modelValue":t[0]||(t[0]=o=>n.customer_id=o),placeholder:"请选择客户（支持搜索）",onChange:Z},null,8,["modelValue"])]),_:1}),s(d,{label:"合同标题",prop:"title"},{default:l(()=>[s(i,{modelValue:n.title,"onUpdate:modelValue":t[1]||(t[1]=o=>n.title=o),placeholder:"请输入合同标题"},null,8,["modelValue"])]),_:1}),s(d,{label:"合同描述",prop:"description"},{default:l(()=>[s(i,{modelValue:n.description,"onUpdate:modelValue":t[2]||(t[2]=o=>n.description=o),type:"textarea",rows:4,placeholder:"请输入合同描述"},null,8,["modelValue"])]),_:1}),s(d,{label:"合同金额",prop:"total_amount"},{default:l(()=>[s(b,{modelValue:n.total_amount,"onUpdate:modelValue":t[3]||(t[3]=o=>n.total_amount=o),min:0,precision:2,style:{width:"100%"},placeholder:"请输入合同金额"},null,8,["modelValue"])]),_:1}),s(d,{label:"开始日期",prop:"start_date"},{default:l(()=>[s(D,{modelValue:n.start_date,"onUpdate:modelValue":t[4]||(t[4]=o=>n.start_date=o),type:"date",placeholder:"请选择开始日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),s(d,{label:"结束日期",prop:"end_date"},{default:l(()=>[s(D,{modelValue:n.end_date,"onUpdate:modelValue":t[5]||(t[5]=o=>n.end_date=o),type:"date",placeholder:"请选择结束日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),s(d,{label:"合同条款",prop:"terms"},{default:l(()=>[s(i,{modelValue:n.terms,"onUpdate:modelValue":t[6]||(t[6]=o=>n.terms=o),type:"textarea",rows:6,placeholder:"请输入合同条款"},null,8,["modelValue"])]),_:1}),s(d,{label:"备注",prop:"notes"},{default:l(()=>[s(i,{modelValue:n.notes,"onUpdate:modelValue":t[7]||(t[7]=o=>n.notes=o),type:"textarea",rows:4,placeholder:"请输入备注信息"},null,8,["modelValue"])]),_:1}),a("div",It,[s(N,{onClick:et},{default:l(()=>t[8]||(t[8]=[y("取消")])),_:1,__:[8]}),s(N,{type:"primary",loading:x.value,onClick:tt},{default:l(()=>[y(r(x.value?"保存中...":"保存"),1)]),_:1},8,["loading"])])]),_:1},8,["model"])),[[lt,F.value]]),m.value&&u.value&&u.value.invoices&&u.value.invoices.length>0?(c(),_("div",Bt,[s(h,{"content-position":"left"},{default:l(()=>t[9]||(t[9]=[a("h3",{class:"text-lg font-semibold"},"关联发票及收款情况",-1)])),_:1,__:[9]}),a("div",qt,[a("div",Lt,[t[10]||(t[10]=a("div",{class:"stat-label"},"发票总数",-1)),a("div",Pt,r(C.value.totalCount),1)]),a("div",Rt,[t[11]||(t[11]=a("div",{class:"stat-label"},"发票总额",-1)),a("div",zt,"¥"+r(v(C.value.totalAmount)),1)]),a("div",$t,[t[12]||(t[12]=a("div",{class:"stat-label"},"未开票总额",-1)),a("div",jt,"¥"+r(v(C.value.uninvoicedAmount)),1)]),a("div",Ot,[t[13]||(t[13]=a("div",{class:"stat-label"},"已收款",-1)),a("div",Yt,"¥"+r(v(C.value.paidAmount)),1)]),a("div",Xt,[t[14]||(t[14]=a("div",{class:"stat-label"},"未收款",-1)),a("div",Zt,"¥"+r(v(C.value.unpaidAmount)),1)])]),s(nt,{data:((O=u.value)==null?void 0:O.invoices)||[],border:"",style:{width:"100%"}},{default:l(()=>[s(p,{prop:"invoice_number",label:"发票编号",width:"150"}),s(p,{prop:"amount",label:"发票金额",width:"120"},{default:l(o=>[y(" ¥"+r(v(o.row.total_amount)),1)]),_:1}),s(p,{prop:"issue_date",label:"开票日期",width:"120"},{default:l(o=>[y(r(R(o.row.issue_date)),1)]),_:1}),s(p,{prop:"status",label:"发票状态",width:"100"},{default:l(o=>[s(T,{type:G(o.row.status)},{default:l(()=>[y(r(H(o.row.status)),1)]),_:2},1032,["type"])]),_:1}),s(p,{label:"收款情况","min-width":"300"},{default:l(o=>[o.row.payments&&o.row.payments.length>0?(c(),_("div",Gt,[(c(!0),_(ht,null,yt(o.row.payments,f=>(c(),_("div",{key:f.id,class:"payment-item"},[a("div",Ht,[a("div",Jt,[a("span",Kt,"¥"+r(v(f.amount)),1),a("span",Qt,r(R(f.payment_date)),1)]),a("div",Wt,[s(T,{size:"small",type:J(f.status)},{default:l(()=>[y(r(K(f.status)),1)]),_:2},1032,["type"]),s(T,{size:"small",type:"info"},{default:l(()=>[y(r(Q(f.payment_method)),1)]),_:2},1024)])]),f.reference_number?(c(),_("div",te," 参考号: "+r(f.reference_number),1)):B("",!0)]))),128)),a("div",ee," 已收: ¥"+r(v(U(o.row)))+" / 未收: ¥"+r(v(o.row.total_amount-U(o.row))),1)])):(c(),_("div",ae,"暂无收款记录"))]),_:1})]),_:1},8,["data"])])):m.value&&u.value&&(!u.value.invoices||u.value.invoices.length===0)?(c(),_("div",se,[s(h,{"content-position":"left"},{default:l(()=>t[15]||(t[15]=[a("h3",{class:"text-lg font-semibold"},"关联发票及收款情况",-1)])),_:1,__:[15]}),t[16]||(t[16]=a("div",{class:"text-center py-8 text-gray-500"},[a("p",null,"该合同暂无关联发票")],-1))])):B("",!0),m.value&&u.value?(c(),_("div",oe,[s(h,{"content-position":"left"},{default:l(()=>t[17]||(t[17]=[a("h3",{class:"text-lg font-semibold"},"合同附件",-1)])),_:1,__:[17]}),a("div",ne,[s(Dt,{"upload-url":`/api/v1/contracts/${A.value}/attachments`,onSuccess:at,onError:st},null,8,["upload-url"])]),s(Nt,{attachments:V.value,loading:S.value,onDelete:ot,onRefresh:j},null,8,["attachments","loading"])])):B("",!0)])])}}});const De=Mt(le,[["__scopeId","data-v-f1055978"]]);export{De as default};
