/* empty css                  *//* empty css                   *//* empty css                     *//* empty css                 *//* empty css                        *//* empty css                     */import{d as L,r as c,x as m,a as P,o as j,c as O,b as p,t as I,N as Y,L as Z,w as n,h as z,i as G,n as D,E as H,P as J,l as E,e as a,g as N,q as K,Z as Q,_ as W,p as X,v as ee}from"./index-d25e5bb6.js";import{i as g}from"./invoice-d53b715f.js";import{C as te}from"./ContractSelect-ee64c959.js";import{C as oe}from"./CustomerSelect-e3d9c8cd.js";/* empty css               *//* empty css                  */import"./contract-1568625f.js";import"./_plugin-vue_export-helper-c27b6911.js";import"./customer-dc2497e6.js";const ae={class:"page-container"},le={class:"page-header"},ne={class:"page-title"},se={class:"form-container"},re={class:"form-actions"},xe=L({__name:"InvoiceForm",setup(ie){const h=z(),V=G(),_=c(),f=c(!1),d=c(!1),r=c(null),u=m(()=>!!V.params.id),b=m(()=>Number(V.params.id)),t=P({contract_id:0,amount:0,tax_rate:0,issue_date:"",description:"",notes:""}),y=m(()=>t.amount*(t.tax_rate||0)/100),k=m(()=>t.amount+y.value),S={contract_id:[{required:!0,message:"请选择合同",trigger:"change"}],amount:[{required:!0,message:"请输入发票金额",trigger:"blur"}],issue_date:[{required:!0,message:"请选择开票日期",trigger:"change"}]},B=(o,e)=>{r.value=o,t.contract_id=0,console.log("Selected customer:",e)},U=(o,e)=>{t.contract_id=o||0,e&&e.customer&&(r.value=e.customer.id),console.log("Selected contract:",e)},w=()=>{},F=o=>{if(!o)return"";const e=new Date(o);if(isNaN(e.getTime()))return"";const s=e.getFullYear(),i=String(e.getMonth()+1).padStart(2,"0"),v=String(e.getDate()).padStart(2,"0");return`${s}-${i}-${v}`},q=o=>{if(!o)return null;const e=new Date(o);return isNaN(e.getTime())?null:e},R=async()=>{if(u.value)try{f.value=!0;const o=await g.getInvoiceById(b.value);if(o.success&&o.data){const e=o.data;Object.assign(t,{...e,issue_date:q(e.issue_date)}),e.contract&&e.contract.customer&&(r.value=e.contract.customer.id)}}catch(o){console.error("Failed to fetch invoice:",o),D.error("获取发票信息失败")}finally{f.value=!1}},T=async()=>{if(_.value)try{await _.value.validate(),d.value=!0;const o={...t,issue_date:F(t.issue_date)};let e;u.value?e=await g.updateInvoice(b.value,o):e=await g.createInvoice(o),e.success&&(D.success(u.value?"更新成功":"创建成功"),h.push("/invoices"))}catch(o){console.error("Failed to submit form:",o)}finally{d.value=!1}},A=()=>{h.go(-1)};return j(()=>{u.value&&R()}),(o,e)=>{const s=K,i=Q,v=W,C=X,x=ee,M=H,$=J;return E(),O("div",ae,[p("div",le,[p("h2",ne,I(u.value?"编辑发票":"新建发票"),1)]),p("div",se,[Y((E(),Z(M,{ref_key:"formRef",ref:_,model:t,rules:S,"label-width":"100px"},{default:n(()=>[a(s,{label:"客户",prop:"customer_id"},{default:n(()=>[a(oe,{modelValue:r.value,"onUpdate:modelValue":e[0]||(e[0]=l=>r.value=l),placeholder:"请选择客户（支持搜索）","only-with-active-contracts":!0,onChange:B},null,8,["modelValue"])]),_:1}),a(s,{label:"合同",prop:"contract_id"},{default:n(()=>[a(te,{modelValue:t.contract_id,"onUpdate:modelValue":e[1]||(e[1]=l=>t.contract_id=l),"customer-id":r.value,placeholder:"请选择合同（支持搜索）",onChange:U},null,8,["modelValue","customer-id"])]),_:1}),a(s,{label:"发票金额",prop:"amount"},{default:n(()=>[a(i,{modelValue:t.amount,"onUpdate:modelValue":e[2]||(e[2]=l=>t.amount=l),min:0,precision:2,style:{width:"100%"},placeholder:"请输入发票金额",onChange:w},null,8,["modelValue"])]),_:1}),a(s,{label:"税率(%)",prop:"tax_rate"},{default:n(()=>[a(i,{modelValue:t.tax_rate,"onUpdate:modelValue":e[3]||(e[3]=l=>t.tax_rate=l),min:0,max:100,precision:2,style:{width:"100%"},placeholder:"请输入税率",onChange:w},null,8,["modelValue"])]),_:1}),a(s,{label:"税额"},{default:n(()=>[a(i,{"model-value":y.value,disabled:"",precision:2,style:{width:"100%"}},null,8,["model-value"])]),_:1}),a(s,{label:"总金额"},{default:n(()=>[a(i,{"model-value":k.value,disabled:"",precision:2,style:{width:"100%"}},null,8,["model-value"])]),_:1}),a(s,{label:"开票日期",prop:"issue_date"},{default:n(()=>[a(v,{modelValue:t.issue_date,"onUpdate:modelValue":e[4]||(e[4]=l=>t.issue_date=l),type:"date",placeholder:"请选择开票日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(s,{label:"发票描述",prop:"description"},{default:n(()=>[a(C,{modelValue:t.description,"onUpdate:modelValue":e[5]||(e[5]=l=>t.description=l),type:"textarea",rows:4,placeholder:"请输入发票描述"},null,8,["modelValue"])]),_:1}),a(s,{label:"备注",prop:"notes"},{default:n(()=>[a(C,{modelValue:t.notes,"onUpdate:modelValue":e[6]||(e[6]=l=>t.notes=l),type:"textarea",rows:4,placeholder:"请输入备注信息"},null,8,["modelValue"])]),_:1}),p("div",re,[a(x,{onClick:A},{default:n(()=>e[7]||(e[7]=[N("取消")])),_:1,__:[7]}),a(x,{type:"primary",loading:d.value,onClick:T},{default:n(()=>[N(I(d.value?"保存中...":"保存"),1)]),_:1},8,["loading"])])]),_:1},8,["model"])),[[$,f.value]])])])}}});export{xe as default};
