/* empty css                  *//* empty css                   *//* empty css                     *//* empty css                 *//* empty css               *//* empty css                  *//* empty css                     *//* empty css                        */import{d as $,r as d,x as k,a as L,o as O,c as j,b as c,t as C,N as A,L as Q,w as n,h as Y,i as Z,n as E,E as z,P as G,l as I,e as a,g as N,q as H,Z as J,_ as K,T as W,Q as X,p as ee,v as te}from"./index-2473cdd3.js";import{p as y}from"./payment-d8a74b37.js";import{I as ae}from"./InvoiceSelect-0431a41c.js";import{C as oe}from"./CustomerSelect-086399ec.js";import"./invoice-51097eef.js";import"./_plugin-vue_export-helper-c27b6911.js";import"./customer-5b4041b8.js";const le={class:"page-container"},ne={class:"page-header"},re={class:"page-title"},se={class:"form-container"},ie={class:"form-actions"},Ee=$({__name:"PaymentForm",setup(ue){const h=Y(),p=Z(),_=d(),f=d(!1),m=d(!1),s=d(null),i=k(()=>!!p.params.id),b=k(()=>Number(p.params.id)),o=L({invoice_id:0,amount:0,payment_date:"",payment_method:"bank_transfer",reference_number:"",notes:""}),D={invoice_id:[{required:!0,message:"请选择发票",trigger:"change"}],amount:[{required:!0,message:"请输入支付金额",trigger:"blur"}],payment_date:[{required:!0,message:"请选择支付日期",trigger:"change"}],payment_method:[{required:!0,message:"请选择支付方式",trigger:"change"}]},S=(t,e)=>{s.value=t,o.invoice_id=0,console.log("Selected customer:",e)},x=(t,e)=>{o.invoice_id=t||0,e&&e.contract&&e.contract.customer&&(s.value=e.contract.customer.id),console.log("Selected invoice:",e)},B=t=>{if(!t)return"";const e=new Date(t);if(isNaN(e.getTime()))return"";const r=e.getFullYear(),v=String(e.getMonth()+1).padStart(2,"0"),g=String(e.getDate()).padStart(2,"0");return`${r}-${v}-${g}`},P=t=>{if(!t)return null;const e=new Date(t);return isNaN(e.getTime())?null:e},U=async()=>{if(i.value)try{f.value=!0;const t=await y.getPaymentById(b.value);if(t.success&&t.data){const e=t.data;Object.assign(o,{...e,payment_date:P(e.payment_date)}),e.invoice&&e.invoice.contract&&e.invoice.contract.customer&&(s.value=e.invoice.contract.customer.id)}}catch(t){console.error("Failed to fetch payment:",t),E.error("获取支付记录失败")}finally{f.value=!1}},q=async()=>{if(_.value)try{await _.value.validate(),m.value=!0;const t={...o,payment_date:B(o.payment_date)};let e;i.value?e=await y.updatePayment(b.value,t):e=await y.createPayment(t),e.success&&(E.success(i.value?"更新成功":"创建成功"),h.push("/payments"))}catch(t){console.error("Failed to submit form:",t)}finally{m.value=!1}},F=()=>{h.go(-1)};return O(()=>{if(i.value)U();else{const t=p.query.invoiceId;t&&(o.invoice_id=Number(t))}}),(t,e)=>{const r=H,v=J,g=K,u=W,R=X,V=ee,w=te,T=z,M=G;return I(),j("div",le,[c("div",ne,[c("h2",re,C(i.value?"编辑支付":"新建支付"),1)]),c("div",se,[A((I(),Q(T,{ref_key:"formRef",ref:_,model:o,rules:D,"label-width":"100px"},{default:n(()=>[a(r,{label:"客户",prop:"customer_id"},{default:n(()=>[a(oe,{modelValue:s.value,"onUpdate:modelValue":e[0]||(e[0]=l=>s.value=l),placeholder:"请选择客户（支持搜索）","only-with-unpaid-invoices":!0,onChange:S},null,8,["modelValue"])]),_:1}),a(r,{label:"发票",prop:"invoice_id"},{default:n(()=>[a(ae,{modelValue:o.invoice_id,"onUpdate:modelValue":e[1]||(e[1]=l=>o.invoice_id=l),"customer-id":s.value,placeholder:"请选择发票（支持搜索）",onChange:x},null,8,["modelValue","customer-id"])]),_:1}),a(r,{label:"支付金额",prop:"amount"},{default:n(()=>[a(v,{modelValue:o.amount,"onUpdate:modelValue":e[2]||(e[2]=l=>o.amount=l),min:0,precision:2,style:{width:"100%"},placeholder:"请输入支付金额"},null,8,["modelValue"])]),_:1}),a(r,{label:"支付日期",prop:"payment_date"},{default:n(()=>[a(g,{modelValue:o.payment_date,"onUpdate:modelValue":e[3]||(e[3]=l=>o.payment_date=l),type:"date",placeholder:"请选择支付日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(r,{label:"支付方式",prop:"payment_method"},{default:n(()=>[a(R,{modelValue:o.payment_method,"onUpdate:modelValue":e[4]||(e[4]=l=>o.payment_method=l),placeholder:"请选择支付方式",style:{width:"100%"}},{default:n(()=>[a(u,{label:"现金",value:"cash"}),a(u,{label:"银行转账",value:"bank_transfer"}),a(u,{label:"支票",value:"check"}),a(u,{label:"信用卡",value:"credit_card"}),a(u,{label:"其他",value:"other"})]),_:1},8,["modelValue"])]),_:1}),a(r,{label:"参考号",prop:"reference_number"},{default:n(()=>[a(V,{modelValue:o.reference_number,"onUpdate:modelValue":e[5]||(e[5]=l=>o.reference_number=l),placeholder:"请输入参考号或交易号"},null,8,["modelValue"])]),_:1}),a(r,{label:"备注",prop:"notes"},{default:n(()=>[a(V,{modelValue:o.notes,"onUpdate:modelValue":e[6]||(e[6]=l=>o.notes=l),type:"textarea",rows:4,placeholder:"请输入备注信息"},null,8,["modelValue"])]),_:1}),c("div",ie,[a(w,{onClick:F},{default:n(()=>e[7]||(e[7]=[N("取消")])),_:1,__:[7]}),a(w,{type:"primary",loading:m.value,onClick:q},{default:n(()=>[N(C(m.value?"保存中...":"保存"),1)]),_:1},8,["loading"])])]),_:1},8,["model"])),[[M,f.value]])])])}}});export{Ee as default};
