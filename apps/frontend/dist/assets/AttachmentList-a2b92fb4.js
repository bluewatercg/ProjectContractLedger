import{K as v,d as G,r as h,x,c as u,e as p,w as y,b as n,t as F,M as j,n as k,a4 as W,a5 as O,l as c,C as $,a6 as K,g as L,a7 as H,F as M,X,Y,k as q,L as T,a8 as Q,a9 as Z,aa as ee,ab as te,ac as ae,y as oe,ad as se,ae as ne,v as le}from"./index-2a26122f.js";/* empty css                  */import{_ as N}from"./_plugin-vue_export-helper-c27b6911.js";/* empty css                   */const Ie={getContractAttachments(s){return v.get(`/contracts/${s}/attachments`).then(o=>o.data)},uploadContractAttachment(s,o){const r=new FormData;return r.append("file",o),v.post(`/contracts/${s}/attachments`,r,{headers:{"Content-Type":"multipart/form-data"}}).then(i=>i.data)},deleteContractAttachment(s,o){return v.delete(`/contracts/${s}/attachments/${o}`).then(r=>r.data)},getInvoiceAttachments(s){return v.get(`/invoices/${s}/attachments`).then(o=>o.data)},uploadInvoiceAttachment(s,o){const r=new FormData;return r.append("file",o),v.post(`/invoices/${s}/attachments`,r,{headers:{"Content-Type":"multipart/form-data"}}).then(i=>i.data)},deleteInvoiceAttachment(s,o){return v.delete(`/invoices/${s}/attachments/${o}`).then(r=>r.data)},downloadAttachment(s){return v.get(`/attachments/${s}/download`,{responseType:"blob"}).then(o=>o.data)},getAttachmentPreviewUrl(s){const o=localStorage.getItem("token");return`${v.defaults.baseURL||"/api/v1"}/attachments/${s}/download?token=${o}`}};const re={class:"file-upload"},ce={class:"upload-area"},ie={key:0,class:"upload-progress"},de={class:"progress-text"},ue=G({__name:"FileUpload",props:{uploadUrl:{},disabled:{type:Boolean,default:!1}},emits:["success","error"],setup(s,{expose:o,emit:r}){const i=s,b=r,_=h(),m=h(!1),l=h(0),U=x(()=>{const t=localStorage.getItem("token");return t?{Authorization:`Bearer ${t}`}:{}}),C=x(()=>{if(i.uploadUrl.startsWith("http"))return i.uploadUrl;const t=H.baseURL,f=i.uploadUrl.startsWith("/")?i.uploadUrl:`/${i.uploadUrl}`;return`${t}${f}`}),B=x(()=>l.value===100?"success":l.value>0?"active":"normal"),P=x(()=>l.value===100?"上传完成":l.value>0?`上传中... ${l.value}%`:"准备上传"),A=t=>{if(!["application/pdf","image/jpeg","image/jpg","image/png"].includes(t.type))return k.error("不支持的文件类型，仅支持 PDF、JPG、JPEG、PNG 格式"),!1;const e=10*1024*1024;return t.size>e?(k.error("文件大小不能超过 10MB"),!1):(m.value=!0,l.value=0,!0)},I=t=>{l.value=Math.round(t.percent||0)},S=(t,f)=>{m.value=!1,l.value=100,t.success?(k.success("文件上传成功"),b("success",t.data)):(k.error(t.message||"上传失败"),b("error",t)),setTimeout(()=>{l.value=0},2e3)},D=t=>{m.value=!1,l.value=0,console.error("Upload error:",t),k.error("文件上传失败"),b("error",t)};return o({clearFiles:()=>{var t;return(t=_.value)==null?void 0:t.clearFiles()},submit:()=>{var t;return(t=_.value)==null?void 0:t.submit()},abort:()=>{var t;return(t=_.value)==null?void 0:t.abort()}}),(t,f)=>{const e=M,a=W,g=O;return c(),u("div",re,[p(a,{ref_key:"uploadRef",ref:_,action:C.value,headers:U.value,"before-upload":A,"on-success":S,"on-error":D,"on-progress":I,"show-file-list":!1,"auto-upload":!0,accept:".pdf,.jpg,.jpeg,.png",drag:""},{default:y(()=>[n("div",ce,[p(e,{class:"upload-icon",size:50},{default:y(()=>[p($(K))]),_:1}),f[0]||(f[0]=n("div",{class:"upload-text"},[n("p",null,[L("将文件拖拽到此处，或"),n("em",null,"点击上传")]),n("p",{class:"upload-tip"},"支持 PDF、JPG、JPEG、PNG 格式，文件大小不超过 10MB")],-1))])]),_:1},8,["action","headers"]),m.value?(c(),u("div",ie,[p(g,{percentage:l.value,status:B.value},null,8,["percentage","status"]),n("p",de,F(P.value),1)])):j("",!0)])}}});const Se=N(ue,[["__scopeId","data-v-ac4351cb"]]);const pe={class:"attachment-list"},_e={class:"list-header"},me={class:"attachment-count"},fe={key:0,class:"loading-container"},ve={key:1,class:"empty-container"},he={key:2,class:"attachment-items"},ge={class:"file-icon"},we={class:"file-info"},ye=["title"],ke={class:"file-meta"},be={class:"file-size"},$e={class:"upload-time"},Ue={class:"file-actions"},Ce={class:"preview-container"},Fe=["src"],Ee=["src"],xe=G({__name:"AttachmentList",props:{attachments:{},loading:{type:Boolean,default:!1}},emits:["delete","refresh"],setup(s,{expose:o,emit:r}){const i=r,b=h(!1),_=h(!1),m=h(null),l=h(""),U=h("image"),C=e=>e.toLowerCase().endsWith(".pdf"),B=e=>[".jpg",".jpeg",".png",".gif",".bmp",".webp"].some(g=>e.toLowerCase().endsWith(g)),P=e=>C(e)||B(e),A=e=>e?e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(1)} MB`:"-",I=e=>new Date(e).toLocaleString("zh-CN"),S=async e=>{try{const a=await fetch(`/api/v1/attachments/${e.attachment_id}/download`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!a.ok)throw new Error("下载失败");const g=await a.blob(),E=window.URL.createObjectURL(g),w=document.createElement("a");w.href=E,w.download=e.file_name,document.body.appendChild(w),w.click(),document.body.removeChild(w),window.URL.revokeObjectURL(E),k.success("文件下载成功")}catch(a){console.error("Download error:",a),k.error("文件下载失败")}},D=e=>{m.value=e,U.value=C(e.file_name)?"pdf":"image";const a=localStorage.getItem("token");l.value=`/api/v1/attachments/${e.attachment_id}/download?token=${a}`,_.value=!0},t=()=>{_.value=!1,m.value=null,l.value=""},f=async e=>{try{await oe.confirm(`确定要删除文件 "${e.file_name}" 吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),b.value=!0,i("delete",e.attachment_id)}catch{}};return o({refreshList:()=>i("refresh")}),(e,a)=>{var z;const g=se,E=ne,w=M,R=le,J=q;return c(),u("div",pe,[n("div",_e,[a[1]||(a[1]=n("h4",null,"附件列表",-1)),n("span",me,F(e.attachments.length)+" 个文件",1)]),e.loading?(c(),u("div",fe,[p(g,{rows:3,animated:""})])):e.attachments.length===0?(c(),u("div",ve,[p(E,{description:"暂无附件"})])):(c(),u("div",he,[(c(!0),u(X,null,Y(e.attachments,d=>(c(),u("div",{key:d.attachment_id,class:"attachment-item"},[n("div",ge,[p(w,{size:24},{default:y(()=>[C(d.file_name)?(c(),T($(Q),{key:0})):(c(),T($(Z),{key:1}))]),_:2},1024)]),n("div",we,[n("div",{class:"file-name",title:d.file_name},F(d.file_name),9,ye),n("div",ke,[n("span",be,F(A(d.file_size)),1),n("span",$e,F(I(d.uploaded_at)),1)])]),n("div",Ue,[p(R,{type:"primary",size:"small",icon:$(ee),onClick:V=>S(d)},{default:y(()=>a[2]||(a[2]=[L(" 下载 ")])),_:2,__:[2]},1032,["icon","onClick"]),P(d.file_name)?(c(),T(R,{key:0,type:"info",size:"small",icon:$(te),onClick:V=>D(d)},{default:y(()=>a[3]||(a[3]=[L(" 预览 ")])),_:2,__:[3]},1032,["icon","onClick"])):j("",!0),p(R,{type:"danger",size:"small",icon:$(ae),onClick:V=>f(d),disabled:b.value},{default:y(()=>a[4]||(a[4]=[L(" 删除 ")])),_:2,__:[4]},1032,["icon","onClick","disabled"])])]))),128))])),p(J,{modelValue:_.value,"onUpdate:modelValue":a[0]||(a[0]=d=>_.value=d),title:(z=m.value)==null?void 0:z.file_name,width:"80%","before-close":t},{default:y(()=>[n("div",Ce,[U.value==="image"?(c(),u("img",{key:0,src:l.value,alt:"预览图片",class:"preview-image"},null,8,Fe)):U.value==="pdf"?(c(),u("iframe",{key:1,src:l.value,class:"preview-pdf",frameborder:"0"},null,8,Ee)):j("",!0)])]),_:1},8,["modelValue","title"])])}}});const De=N(xe,[["__scopeId","data-v-65cbc461"]]);export{De as A,Se as F,Ie as a};
