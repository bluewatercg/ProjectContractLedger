import{K as v,d as M,r as h,x,c as p,e as m,w as y,b as n,t as E,M as j,n as k,a4 as J,a5 as K,l as i,C as b,a6 as O,g as B,F as G,X as H,Y as X,k as Y,L as R,a7 as q,a8 as Q,a9 as Z,aa as ee,ab as te,y as ae,ac as oe,ad as se,v as ne}from"./index-2e96782b.js";/* empty css                  */import{_ as N}from"./_plugin-vue_export-helper-c27b6911.js";/* empty css                   */const Ae={getContractAttachments(s){return v.get(`/contracts/${s}/attachments`).then(o=>o.data)},uploadContractAttachment(s,o){const c=new FormData;return c.append("file",o),v.post(`/contracts/${s}/attachments`,c,{headers:{"Content-Type":"multipart/form-data"}}).then(r=>r.data)},deleteContractAttachment(s,o){return v.delete(`/contracts/${s}/attachments/${o}`).then(c=>c.data)},getInvoiceAttachments(s){return v.get(`/invoices/${s}/attachments`).then(o=>o.data)},uploadInvoiceAttachment(s,o){const c=new FormData;return c.append("file",o),v.post(`/invoices/${s}/attachments`,c,{headers:{"Content-Type":"multipart/form-data"}}).then(r=>r.data)},deleteInvoiceAttachment(s,o){return v.delete(`/invoices/${s}/attachments/${o}`).then(c=>c.data)},downloadAttachment(s){return v.get(`/attachments/${s}/download`,{responseType:"blob"}).then(o=>o.data)},getAttachmentPreviewUrl(s){const o=localStorage.getItem("token");return`${v.defaults.baseURL||"/api/v1"}/attachments/${s}/download?token=${o}`}};const le={class:"file-upload"},re={class:"upload-area"},ce={key:0,class:"upload-progress"},ie={class:"progress-text"},de=M({__name:"FileUpload",props:{uploadUrl:{},disabled:{type:Boolean,default:!1}},emits:["success","error"],setup(s,{expose:o,emit:c}){const r=s,$=c,_=h(),f=h(!1),l=h(0),U=x(()=>{const t=localStorage.getItem("token");return t?{Authorization:`Bearer ${t}`}:{}}),C=x(()=>{if(r.uploadUrl.startsWith("http"))return r.uploadUrl;if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")return`http://localhost:8000/api/v1${r.uploadUrl.startsWith("/")?r.uploadUrl:`/${r.uploadUrl}`}`;{const d="/api",e=r.uploadUrl.startsWith("/")?r.uploadUrl:`/${r.uploadUrl}`;return`${d}${e}`}}),L=x(()=>l.value===100?"success":l.value>0?"active":"normal"),P=x(()=>l.value===100?"上传完成":l.value>0?`上传中... ${l.value}%`:"准备上传"),A=t=>{if(!["application/pdf","image/jpeg","image/jpg","image/png"].includes(t.type))return k.error("不支持的文件类型，仅支持 PDF、JPG、JPEG、PNG 格式"),!1;const e=10*1024*1024;return t.size>e?(k.error("文件大小不能超过 10MB"),!1):(f.value=!0,l.value=0,!0)},D=t=>{l.value=Math.round(t.percent||0)},S=(t,d)=>{f.value=!1,l.value=100,t.success?(k.success("文件上传成功"),$("success",t.data)):(k.error(t.message||"上传失败"),$("error",t)),setTimeout(()=>{l.value=0},2e3)},I=t=>{f.value=!1,l.value=0,console.error("Upload error:",t),k.error("文件上传失败"),$("error",t)};return o({clearFiles:()=>{var t;return(t=_.value)==null?void 0:t.clearFiles()},submit:()=>{var t;return(t=_.value)==null?void 0:t.submit()},abort:t=>{var d;return(d=_.value)==null?void 0:d.abort(t)}}),(t,d)=>{const e=G,a=J,g=K;return i(),p("div",le,[m(a,{ref_key:"uploadRef",ref:_,action:C.value,headers:U.value,"before-upload":A,"on-success":S,"on-error":I,"on-progress":D,"show-file-list":!1,"auto-upload":!0,accept:".pdf,.jpg,.jpeg,.png",drag:""},{default:y(()=>[n("div",re,[m(e,{class:"upload-icon",size:50},{default:y(()=>[m(b(O))]),_:1}),d[0]||(d[0]=n("div",{class:"upload-text"},[n("p",null,[B("将文件拖拽到此处，或"),n("em",null,"点击上传")]),n("p",{class:"upload-tip"},"支持 PDF、JPG、JPEG、PNG 格式，文件大小不超过 10MB")],-1))])]),_:1},8,["action","headers"]),f.value?(i(),p("div",ce,[m(g,{percentage:l.value,status:L.value},null,8,["percentage","status"]),n("p",ie,E(P.value),1)])):j("",!0)])}}});const De=N(de,[["__scopeId","data-v-560cd89f"]]);const ue={class:"attachment-list"},pe={class:"list-header"},me={class:"attachment-count"},_e={key:0,class:"loading-container"},fe={key:1,class:"empty-container"},ve={key:2,class:"attachment-items"},he={class:"file-icon"},ge={class:"file-info"},we=["title"],ye={class:"file-meta"},ke={class:"file-size"},$e={class:"upload-time"},be={class:"file-actions"},Ue={class:"preview-container"},Ce=["src"],Ee=["src"],Fe=M({__name:"AttachmentList",props:{attachments:{},loading:{type:Boolean,default:!1}},emits:["delete","refresh"],setup(s,{expose:o,emit:c}){const r=c,$=h(!1),_=h(!1),f=h(null),l=h(""),U=h("image"),C=e=>e.toLowerCase().endsWith(".pdf"),L=e=>[".jpg",".jpeg",".png",".gif",".bmp",".webp"].some(g=>e.toLowerCase().endsWith(g)),P=e=>C(e)||L(e),A=e=>e?e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(1)} MB`:"-",D=e=>new Date(e).toLocaleString("zh-CN"),S=async e=>{try{const a=await fetch(`/api/v1/attachments/${e.attachment_id}/download`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!a.ok)throw new Error("下载失败");const g=await a.blob(),F=window.URL.createObjectURL(g),w=document.createElement("a");w.href=F,w.download=e.file_name,document.body.appendChild(w),w.click(),document.body.removeChild(w),window.URL.revokeObjectURL(F),k.success("文件下载成功")}catch(a){console.error("Download error:",a),k.error("文件下载失败")}},I=e=>{f.value=e,U.value=C(e.file_name)?"pdf":"image";const a=localStorage.getItem("token");l.value=`/api/v1/attachments/${e.attachment_id}/download?token=${a}`,_.value=!0},t=()=>{_.value=!1,f.value=null,l.value=""},d=async e=>{try{await ae.confirm(`确定要删除文件 "${e.file_name}" 吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),$.value=!0,r("delete",e.attachment_id)}catch{}};return o({refreshList:()=>r("refresh")}),(e,a)=>{var z;const g=oe,F=se,w=G,T=ne,W=Y;return i(),p("div",ue,[n("div",pe,[a[1]||(a[1]=n("h4",null,"附件列表",-1)),n("span",me,E(e.attachments.length)+" 个文件",1)]),e.loading?(i(),p("div",_e,[m(g,{rows:3,animated:""})])):e.attachments.length===0?(i(),p("div",fe,[m(F,{description:"暂无附件"})])):(i(),p("div",ve,[(i(!0),p(H,null,X(e.attachments,u=>(i(),p("div",{key:u.attachment_id,class:"attachment-item"},[n("div",he,[m(w,{size:24},{default:y(()=>[C(u.file_name)?(i(),R(b(q),{key:0})):(i(),R(b(Q),{key:1}))]),_:2},1024)]),n("div",ge,[n("div",{class:"file-name",title:u.file_name},E(u.file_name),9,we),n("div",ye,[n("span",ke,E(A(u.file_size)),1),n("span",$e,E(D(u.uploaded_at)),1)])]),n("div",be,[m(T,{type:"primary",size:"small",icon:b(Z),onClick:V=>S(u)},{default:y(()=>a[2]||(a[2]=[B(" 下载 ")])),_:2,__:[2]},1032,["icon","onClick"]),P(u.file_name)?(i(),R(T,{key:0,type:"info",size:"small",icon:b(ee),onClick:V=>I(u)},{default:y(()=>a[3]||(a[3]=[B(" 预览 ")])),_:2,__:[3]},1032,["icon","onClick"])):j("",!0),m(T,{type:"danger",size:"small",icon:b(te),onClick:V=>d(u),disabled:$.value},{default:y(()=>a[4]||(a[4]=[B(" 删除 ")])),_:2,__:[4]},1032,["icon","onClick","disabled"])])]))),128))])),m(W,{modelValue:_.value,"onUpdate:modelValue":a[0]||(a[0]=u=>_.value=u),title:(z=f.value)==null?void 0:z.file_name,width:"80%","before-close":t},{default:y(()=>[n("div",Ue,[U.value==="image"?(i(),p("img",{key:0,src:l.value,alt:"预览图片",class:"preview-image"},null,8,Ce)):U.value==="pdf"?(i(),p("iframe",{key:1,src:l.value,class:"preview-pdf",frameborder:"0"},null,8,Ee)):j("",!0)])]),_:1},8,["modelValue","title"])])}}});const Se=N(Fe,[["__scopeId","data-v-65cbc461"]]);export{Se as A,De as F,Ae as a};
