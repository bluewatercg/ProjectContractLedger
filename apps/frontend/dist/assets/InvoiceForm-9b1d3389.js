/* empty css                  *//* empty css                   *//* empty css                   *//* empty css                     *//* empty css                 *//* empty css                        *//* empty css                     */import{d as J,r as d,x as f,a as K,o as Q,c as U,b as m,t as k,N as W,L as X,w as n,e as a,M as ee,h as te,i as ae,n as r,E as oe,j as le,P as se,l as w,g as S,q as ne,Z as re,_ as ie,p as ue,v as ce}from"./index-2473cdd3.js";import{i as C}from"./invoice-51097eef.js";import{F as de,A as me,a as F}from"./AttachmentList-eab5fe5a.js";import{C as pe}from"./ContractSelect-2942b424.js";import{C as _e}from"./CustomerSelect-086399ec.js";import"./_plugin-vue_export-helper-c27b6911.js";/* empty css                   *//* empty css               *//* empty css                  */import"./contract-51d9882f.js";import"./customer-5b4041b8.js";const ve={class:"page-container"},fe={class:"page-header"},he={class:"page-title"},ge={class:"form-container"},ye={class:"form-actions"},be={key:0,class:"mt-8"},Ve={class:"mb-4"},je=J({__name:"InvoiceForm",setup(we){const x=te(),h=ae(),g=d(),y=d(!1),v=d(!1),u=d(null),p=d([]),b=d(!1),i=f(()=>!!h.params.id),_=f(()=>Number(h.params.id)),o=K({contract_id:0,amount:0,tax_rate:0,issue_date:"",description:"",notes:""}),D=f(()=>o.amount*(o.tax_rate||0)/100),B=f(()=>o.amount+D.value),q={contract_id:[{required:!0,message:"请选择合同",trigger:"change"}],amount:[{required:!0,message:"请输入发票金额",trigger:"blur"}],issue_date:[{required:!0,message:"请选择开票日期",trigger:"change"}]},R=(t,e)=>{u.value=t,o.contract_id=0,console.log("Selected customer:",e)},L=(t,e)=>{o.contract_id=t||0,e&&e.customer&&(u.value=e.customer.id),console.log("Selected contract:",e)},I=()=>{},M=t=>{if(!t)return"";const e=new Date(t);if(isNaN(e.getTime()))return"";const l=e.getFullYear(),c=String(e.getMonth()+1).padStart(2,"0"),V=String(e.getDate()).padStart(2,"0");return`${l}-${c}-${V}`},T=t=>{if(!t)return null;const e=new Date(t);return isNaN(e.getTime())?null:e},$=async()=>{if(i.value)try{y.value=!0;const t=await C.getInvoiceById(_.value);if(t.success&&t.data){const e=t.data;Object.assign(o,{...e,issue_date:T(e.issue_date)}),e.contract&&e.contract.customer&&(u.value=e.contract.customer.id)}}catch(t){console.error("Failed to fetch invoice:",t),r.error("获取发票信息失败")}finally{y.value=!1}},j=async()=>{if(g.value)try{await g.value.validate(),v.value=!0;const t={...o,issue_date:M(o.issue_date)};let e;i.value?e=await C.updateInvoice(_.value,t):e=await C.createInvoice(t),e.success&&(r.success(i.value?"更新成功":"创建成功"),x.push("/invoices"))}catch(t){console.error("Failed to submit form:",t)}finally{v.value=!1}},P=()=>{x.go(-1)},E=async()=>{if(i.value)try{b.value=!0;const t=await F.getInvoiceAttachments(_.value);t.success&&t.data&&(p.value=t.data)}catch(t){console.error("Failed to fetch attachments:",t),r.error("获取附件列表失败")}finally{b.value=!1}},O=t=>{p.value.unshift(t),r.success("附件上传成功")},Y=t=>{console.error("Upload error:",t),r.error("附件上传失败")},Z=async t=>{try{const e=await F.deleteInvoiceAttachment(_.value,t);e.success?(p.value=p.value.filter(l=>l.attachment_id!==t),r.success("附件删除成功")):r.error(e.message||"删除失败")}catch(e){console.error("Delete error:",e),r.error("删除附件失败")}};return Q(()=>{if(i.value)$(),E();else{const t=h.query.contractId;t&&(o.contract_id=Number(t))}}),(t,e)=>{const l=ne,c=re,V=ie,N=ue,A=ce,z=oe,G=le,H=se;return w(),U("div",ve,[m("div",fe,[m("h2",he,k(i.value?"编辑发票":"新建发票"),1)]),m("div",ge,[W((w(),X(z,{ref_key:"formRef",ref:g,model:o,rules:q,"label-width":"100px"},{default:n(()=>[a(l,{label:"客户",prop:"customer_id"},{default:n(()=>[a(_e,{modelValue:u.value,"onUpdate:modelValue":e[0]||(e[0]=s=>u.value=s),placeholder:"请选择客户（支持搜索）","only-with-active-contracts":!0,onChange:R},null,8,["modelValue"])]),_:1}),a(l,{label:"合同",prop:"contract_id"},{default:n(()=>[a(pe,{modelValue:o.contract_id,"onUpdate:modelValue":e[1]||(e[1]=s=>o.contract_id=s),"customer-id":u.value,placeholder:"请选择合同（支持搜索）",onChange:L},null,8,["modelValue","customer-id"])]),_:1}),a(l,{label:"发票金额",prop:"amount"},{default:n(()=>[a(c,{modelValue:o.amount,"onUpdate:modelValue":e[2]||(e[2]=s=>o.amount=s),min:0,precision:2,style:{width:"100%"},placeholder:"请输入发票金额",onChange:I},null,8,["modelValue"])]),_:1}),a(l,{label:"税率(%)",prop:"tax_rate"},{default:n(()=>[a(c,{modelValue:o.tax_rate,"onUpdate:modelValue":e[3]||(e[3]=s=>o.tax_rate=s),min:0,max:100,precision:2,style:{width:"100%"},placeholder:"请输入税率",onChange:I},null,8,["modelValue"])]),_:1}),a(l,{label:"税额"},{default:n(()=>[a(c,{"model-value":D.value,disabled:"",precision:2,style:{width:"100%"}},null,8,["model-value"])]),_:1}),a(l,{label:"总金额"},{default:n(()=>[a(c,{"model-value":B.value,disabled:"",precision:2,style:{width:"100%"}},null,8,["model-value"])]),_:1}),a(l,{label:"开票日期",prop:"issue_date"},{default:n(()=>[a(V,{modelValue:o.issue_date,"onUpdate:modelValue":e[4]||(e[4]=s=>o.issue_date=s),type:"date",placeholder:"请选择开票日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(l,{label:"发票描述",prop:"description"},{default:n(()=>[a(N,{modelValue:o.description,"onUpdate:modelValue":e[5]||(e[5]=s=>o.description=s),type:"textarea",rows:4,placeholder:"请输入发票描述"},null,8,["modelValue"])]),_:1}),a(l,{label:"备注",prop:"notes"},{default:n(()=>[a(N,{modelValue:o.notes,"onUpdate:modelValue":e[6]||(e[6]=s=>o.notes=s),type:"textarea",rows:4,placeholder:"请输入备注信息"},null,8,["modelValue"])]),_:1}),m("div",ye,[a(A,{onClick:P},{default:n(()=>e[7]||(e[7]=[S("取消")])),_:1,__:[7]}),a(A,{type:"primary",loading:v.value,onClick:j},{default:n(()=>[S(k(v.value?"保存中...":"保存"),1)]),_:1},8,["loading"])])]),_:1},8,["model"])),[[H,y.value]]),i.value?(w(),U("div",be,[a(G,{"content-position":"left"},{default:n(()=>e[8]||(e[8]=[m("h3",{class:"text-lg font-semibold"},"发票附件",-1)])),_:1,__:[8]}),m("div",Ve,[a(de,{"upload-url":`/api/v1/invoices/${_.value}/attachments`,onSuccess:O,onError:Y},null,8,["upload-url"])]),a(me,{attachments:p.value,loading:b.value,onDelete:Z,onRefresh:E},null,8,["attachments","loading"])])):ee("",!0)])])}}});export{je as default};
