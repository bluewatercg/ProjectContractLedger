import{K as m,d as M,r as f,x as T,c as u,e as p,w as g,b as n,t as U,M as j,n as w,a4 as K,a5 as O,l as c,C as b,a6 as W,g as B,F as G,X as H,Y as X,k as Y,L as R,a7 as q,a8 as Q,a9 as Z,aa as ee,ab as te,y as ae,ac as oe,ad as se,v as ne}from"./index-94d61daa.js";/* empty css                  */import{_ as N}from"./_plugin-vue_export-helper-c27b6911.js";/* empty css                   */const Ae={getContractAttachments(s){return m.get(`/contracts/${s}/attachments`).then(a=>a.data)},uploadContractAttachment(s,a){const r=new FormData;return r.append("file",a),m.post(`/contracts/${s}/attachments`,r,{headers:{"Content-Type":"multipart/form-data"}}).then(d=>d.data)},deleteContractAttachment(s,a){return m.delete(`/contracts/${s}/attachments/${a}`).then(r=>r.data)},getInvoiceAttachments(s){return m.get(`/invoices/${s}/attachments`).then(a=>a.data)},uploadInvoiceAttachment(s,a){const r=new FormData;return r.append("file",a),m.post(`/invoices/${s}/attachments`,r,{headers:{"Content-Type":"multipart/form-data"}}).then(d=>d.data)},deleteInvoiceAttachment(s,a){return m.delete(`/invoices/${s}/attachments/${a}`).then(r=>r.data)},downloadAttachment(s){return m.get(`/attachments/${s}/download`,{responseType:"blob"}).then(a=>a.data)},getAttachmentPreviewUrl(s){const a=localStorage.getItem("token");return`${m.defaults.baseURL||"/api/v1"}/attachments/${s}/download?token=${a}`}};const le={class:"file-upload"},re={class:"upload-area"},ce={key:0,class:"upload-progress"},ie={class:"progress-text"},de=M({__name:"FileUpload",props:{uploadUrl:{},disabled:{type:Boolean,default:!1}},emits:["success","error"],setup(s,{expose:a,emit:r}){const d=r,v=f(),_=f(!1),l=f(0),y=T(()=>{const t=localStorage.getItem("token");return t?{Authorization:`Bearer ${t}`}:{}}),$=T(()=>l.value===100?"success":l.value>0?"active":"normal"),C=T(()=>l.value===100?"上传完成":l.value>0?`上传中... ${l.value}%`:"准备上传"),L=t=>{if(!["application/pdf","image/jpeg","image/jpg","image/png"].includes(t.type))return w.error("不支持的文件类型，仅支持 PDF、JPG、JPEG、PNG 格式"),!1;const E=10*1024*1024;return t.size>E?(w.error("文件大小不能超过 10MB"),!1):(_.value=!0,l.value=0,!0)},P=t=>{l.value=Math.round(t.percent||0)},A=(t,k)=>{_.value=!1,l.value=100,t.success?(w.success("文件上传成功"),d("success",t.data)):(w.error(t.message||"上传失败"),d("error",t)),setTimeout(()=>{l.value=0},2e3)},S=t=>{_.value=!1,l.value=0,console.error("Upload error:",t),w.error("文件上传失败"),d("error",t)};return a({clearFiles:()=>{var t;return(t=v.value)==null?void 0:t.clearFiles()},submit:()=>{var t;return(t=v.value)==null?void 0:t.submit()},abort:()=>{var t;return(t=v.value)==null?void 0:t.abort()}}),(t,k)=>{const E=G,D=K,e=O;return c(),u("div",le,[p(D,{ref_key:"uploadRef",ref:v,action:t.uploadUrl,headers:y.value,"before-upload":L,"on-success":A,"on-error":S,"on-progress":P,"show-file-list":!1,"auto-upload":!0,accept:".pdf,.jpg,.jpeg,.png",drag:""},{default:g(()=>[n("div",re,[p(E,{class:"upload-icon",size:50},{default:g(()=>[p(b(W))]),_:1}),k[0]||(k[0]=n("div",{class:"upload-text"},[n("p",null,[B("将文件拖拽到此处，或"),n("em",null,"点击上传")]),n("p",{class:"upload-tip"},"支持 PDF、JPG、JPEG、PNG 格式，文件大小不超过 10MB")],-1))])]),_:1},8,["action","headers"]),_.value?(c(),u("div",ce,[p(e,{percentage:l.value,status:$.value},null,8,["percentage","status"]),n("p",ie,U(C.value),1)])):j("",!0)])}}});const Se=N(de,[["__scopeId","data-v-0b1da647"]]);const ue={class:"attachment-list"},pe={class:"list-header"},_e={class:"attachment-count"},me={key:0,class:"loading-container"},fe={key:1,class:"empty-container"},ve={key:2,class:"attachment-items"},he={class:"file-icon"},ge={class:"file-info"},we=["title"],ye={class:"file-meta"},ke={class:"file-size"},be={class:"upload-time"},$e={class:"file-actions"},Ce={class:"preview-container"},Ee=["src"],Fe=["src"],Ue=M({__name:"AttachmentList",props:{attachments:{},loading:{type:Boolean,default:!1}},emits:["delete","refresh"],setup(s,{expose:a,emit:r}){const d=r,v=f(!1),_=f(!1),l=f(null),y=f(""),$=f("image"),C=e=>e.toLowerCase().endsWith(".pdf"),L=e=>[".jpg",".jpeg",".png",".gif",".bmp",".webp"].some(F=>e.toLowerCase().endsWith(F)),P=e=>C(e)||L(e),A=e=>e?e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(1)} MB`:"-",S=e=>new Date(e).toLocaleString("zh-CN"),t=async e=>{try{const o=await fetch(`/api/v1/attachments/${e.attachment_id}/download`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!o.ok)throw new Error("下载失败");const F=await o.blob(),x=window.URL.createObjectURL(F),h=document.createElement("a");h.href=x,h.download=e.file_name,document.body.appendChild(h),h.click(),document.body.removeChild(h),window.URL.revokeObjectURL(x),w.success("文件下载成功")}catch(o){console.error("Download error:",o),w.error("文件下载失败")}},k=e=>{l.value=e,$.value=C(e.file_name)?"pdf":"image";const o=localStorage.getItem("token");y.value=`/api/v1/attachments/${e.attachment_id}/download?token=${o}`,_.value=!0},E=()=>{_.value=!1,l.value=null,y.value=""},D=async e=>{try{await ae.confirm(`确定要删除文件 "${e.file_name}" 吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),v.value=!0,d("delete",e.attachment_id)}catch{}};return a({refreshList:()=>d("refresh")}),(e,o)=>{var z;const F=oe,x=se,h=G,I=ne,J=Y;return c(),u("div",ue,[n("div",pe,[o[1]||(o[1]=n("h4",null,"附件列表",-1)),n("span",_e,U(e.attachments.length)+" 个文件",1)]),e.loading?(c(),u("div",me,[p(F,{rows:3,animated:""})])):e.attachments.length===0?(c(),u("div",fe,[p(x,{description:"暂无附件"})])):(c(),u("div",ve,[(c(!0),u(H,null,X(e.attachments,i=>(c(),u("div",{key:i.attachment_id,class:"attachment-item"},[n("div",he,[p(h,{size:24},{default:g(()=>[C(i.file_name)?(c(),R(b(q),{key:0})):(c(),R(b(Q),{key:1}))]),_:2},1024)]),n("div",ge,[n("div",{class:"file-name",title:i.file_name},U(i.file_name),9,we),n("div",ye,[n("span",ke,U(A(i.file_size)),1),n("span",be,U(S(i.uploaded_at)),1)])]),n("div",$e,[p(I,{type:"primary",size:"small",icon:b(Z),onClick:V=>t(i)},{default:g(()=>o[2]||(o[2]=[B(" 下载 ")])),_:2,__:[2]},1032,["icon","onClick"]),P(i.file_name)?(c(),R(I,{key:0,type:"info",size:"small",icon:b(ee),onClick:V=>k(i)},{default:g(()=>o[3]||(o[3]=[B(" 预览 ")])),_:2,__:[3]},1032,["icon","onClick"])):j("",!0),p(I,{type:"danger",size:"small",icon:b(te),onClick:V=>D(i),disabled:v.value},{default:g(()=>o[4]||(o[4]=[B(" 删除 ")])),_:2,__:[4]},1032,["icon","onClick","disabled"])])]))),128))])),p(J,{modelValue:_.value,"onUpdate:modelValue":o[0]||(o[0]=i=>_.value=i),title:(z=l.value)==null?void 0:z.file_name,width:"80%","before-close":E},{default:g(()=>[n("div",Ce,[$.value==="image"?(c(),u("img",{key:0,src:y.value,alt:"预览图片",class:"preview-image"},null,8,Ee)):$.value==="pdf"?(c(),u("iframe",{key:1,src:y.value,class:"preview-pdf",frameborder:"0"},null,8,Fe)):j("",!0)])]),_:1},8,["modelValue","title"])])}}});const De=N(Ue,[["__scopeId","data-v-65cbc461"]]);export{De as A,Se as F,Ae as a};
