/* empty css                  *//* empty css                   *//* empty css                        *//* empty css                    */import"./el-tooltip-4ed993c7.js";/* empty css                     *//* empty css               *//* empty css                   *//* empty css                     *//* empty css                        *//* empty css                 */import{d as tt,r as N,x as S,a as et,o as at,c as v,b as a,t as r,N as ot,L as st,w as l,e as s,M as z,h as nt,i as lt,n as L,E as rt,j as dt,R as it,P as ut,l as m,g,X as ct,Y as mt,q as pt,p as _t,Z as vt,_ as ft,v as gt,U as yt,O as bt}from"./index-16731161.js";import{c as T}from"./contract-68c47a57.js";import{C as ht}from"./CustomerSelect-685a18cf.js";import{_ as wt}from"./_plugin-vue_export-helper-c27b6911.js";/* empty css                  */import"./customer-00c7240a.js";const Vt={class:"page-container"},Ct={class:"page-header"},xt={class:"page-title"},At={class:"form-container"},Nt={class:"form-actions"},kt={key:0,class:"mt-8"},Dt={class:"stats-container"},Mt={class:"stat-card stat-card-blue"},Et={class:"stat-value"},St={class:"stat-card stat-card-green"},Tt={class:"stat-value"},Ft={class:"stat-card stat-card-purple"},It={class:"stat-value"},Ut={class:"stat-card stat-card-orange"},Bt={class:"stat-value"},qt={class:"stat-card stat-card-red"},Pt={class:"stat-value"},Rt={key:0},zt={class:"payment-header"},Lt={class:"payment-amount"},$t={class:"amount-text"},jt={class:"date-text"},Ot={class:"payment-tags"},Yt={key:0,class:"reference-number"},Xt={class:"payment-summary"},Zt={key:1,class:"text-gray-500 text-sm"},Gt={key:1,class:"mt-8"},Ht=tt({__name:"ContractForm",setup(Jt){const F=nt(),I=lt(),k=N(),D=N(!1),w=N(!1),d=N(null),f=S(()=>!!I.params.id),U=S(()=>Number(I.params.id)),V=e=>{if(e==null||e==="")return 0;const t=Number(e);return isNaN(t)?0:t},h=S(()=>{var A;if(!((A=d.value)!=null&&A.invoices)||!Array.isArray(d.value.invoices))return{totalCount:0,totalAmount:0,paidAmount:0,unpaidAmount:0,uninvoicedAmount:d.value?V(d.value.total_amount):0};const e=d.value.invoices,t=V(d.value.total_amount),i=e.length,u=e.reduce((b,c)=>b+V(c.total_amount),0),y=e.reduce((b,c)=>b+M(c),0),C=u-y,x=t-u;return{totalCount:i,totalAmount:u,paidAmount:y,unpaidAmount:C,uninvoicedAmount:x}}),n=et({customer_id:0,title:"",description:"",total_amount:0,start_date:"",end_date:"",terms:"",notes:""}),$={customer_id:[{required:!0,message:"请选择客户",trigger:"change"}],title:[{required:!0,message:"请输入合同标题",trigger:"blur"}],total_amount:[{required:!0,message:"请输入合同金额",trigger:"blur"}],start_date:[{required:!0,message:"请选择开始日期",trigger:"change"}],end_date:[{required:!0,message:"请选择结束日期",trigger:"change"}]},j=(e,t)=>{n.customer_id=e||0,console.log("Selected customer:",t)},p=e=>new Intl.NumberFormat("zh-CN").format(e),B=e=>e?new Date(e).toLocaleDateString("zh-CN"):"-",O=e=>({draft:"info",sent:"warning",paid:"success",overdue:"danger",cancelled:"primary"})[e]||"info",Y=e=>({draft:"草稿",sent:"已发送",paid:"已付款",overdue:"逾期",cancelled:"已取消"})[e]||e,X=e=>({pending:"warning",completed:"success",failed:"danger"})[e]||"info",Z=e=>({pending:"待处理",completed:"已完成",failed:"失败"})[e]||e,G=e=>({cash:"现金",bank_transfer:"银行转账",check:"支票",credit_card:"信用卡",other:"其他"})[e]||e,M=e=>!e.payments||!Array.isArray(e.payments)||e.payments.length===0?0:e.payments.filter(t=>t.status==="completed").reduce((t,i)=>t+V(i.amount),0),q=e=>{if(!e)return null;const t=new Date(e);return isNaN(t.getTime())?null:t},H=async()=>{if(f.value)try{D.value=!0;const e=await T.getContractById(U.value);if(e.success&&e.data){const t=e.data;d.value=t,Object.assign(n,{...t,start_date:q(t.start_date),end_date:q(t.end_date)})}}catch(e){console.error("Failed to fetch contract:",e),L.error("获取合同信息失败")}finally{D.value=!1}},P=e=>{if(!e)return"";const t=new Date(e);if(isNaN(t.getTime()))return"";const i=t.getFullYear(),u=String(t.getMonth()+1).padStart(2,"0"),y=String(t.getDate()).padStart(2,"0");return`${i}-${u}-${y}`},J=async()=>{if(k.value)try{await k.value.validate(),w.value=!0;const e={...n,start_date:P(n.start_date),end_date:P(n.end_date)};let t;f.value?t=await T.updateContract(U.value,e):t=await T.createContract(e),t.success&&(L.success(f.value?"更新成功":"创建成功"),F.push("/contracts"))}catch(e){console.error("Failed to submit form:",e)}finally{w.value=!1}},K=()=>{F.go(-1)};return at(async()=>{f.value&&await H()}),(e,t)=>{var R;const i=pt,u=_t,y=vt,C=ft,x=gt,A=rt,b=dt,c=yt,E=bt,Q=it,W=ut;return m(),v("div",Vt,[a("div",Ct,[a("h2",xt,r(f.value?"编辑合同":"新建合同"),1)]),a("div",At,[ot((m(),st(A,{ref_key:"formRef",ref:k,model:n,rules:$,"label-width":"100px"},{default:l(()=>[s(i,{label:"客户",prop:"customer_id"},{default:l(()=>[s(ht,{modelValue:n.customer_id,"onUpdate:modelValue":t[0]||(t[0]=o=>n.customer_id=o),placeholder:"请选择客户（支持搜索）",onChange:j},null,8,["modelValue"])]),_:1}),s(i,{label:"合同标题",prop:"title"},{default:l(()=>[s(u,{modelValue:n.title,"onUpdate:modelValue":t[1]||(t[1]=o=>n.title=o),placeholder:"请输入合同标题"},null,8,["modelValue"])]),_:1}),s(i,{label:"合同描述",prop:"description"},{default:l(()=>[s(u,{modelValue:n.description,"onUpdate:modelValue":t[2]||(t[2]=o=>n.description=o),type:"textarea",rows:4,placeholder:"请输入合同描述"},null,8,["modelValue"])]),_:1}),s(i,{label:"合同金额",prop:"total_amount"},{default:l(()=>[s(y,{modelValue:n.total_amount,"onUpdate:modelValue":t[3]||(t[3]=o=>n.total_amount=o),min:0,precision:2,style:{width:"100%"},placeholder:"请输入合同金额"},null,8,["modelValue"])]),_:1}),s(i,{label:"开始日期",prop:"start_date"},{default:l(()=>[s(C,{modelValue:n.start_date,"onUpdate:modelValue":t[4]||(t[4]=o=>n.start_date=o),type:"date",placeholder:"请选择开始日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),s(i,{label:"结束日期",prop:"end_date"},{default:l(()=>[s(C,{modelValue:n.end_date,"onUpdate:modelValue":t[5]||(t[5]=o=>n.end_date=o),type:"date",placeholder:"请选择结束日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),s(i,{label:"合同条款",prop:"terms"},{default:l(()=>[s(u,{modelValue:n.terms,"onUpdate:modelValue":t[6]||(t[6]=o=>n.terms=o),type:"textarea",rows:6,placeholder:"请输入合同条款"},null,8,["modelValue"])]),_:1}),s(i,{label:"备注",prop:"notes"},{default:l(()=>[s(u,{modelValue:n.notes,"onUpdate:modelValue":t[7]||(t[7]=o=>n.notes=o),type:"textarea",rows:4,placeholder:"请输入备注信息"},null,8,["modelValue"])]),_:1}),a("div",Nt,[s(x,{onClick:K},{default:l(()=>t[8]||(t[8]=[g("取消")])),_:1,__:[8]}),s(x,{type:"primary",loading:w.value,onClick:J},{default:l(()=>[g(r(w.value?"保存中...":"保存"),1)]),_:1},8,["loading"])])]),_:1},8,["model"])),[[W,D.value]]),f.value&&d.value&&d.value.invoices&&d.value.invoices.length>0?(m(),v("div",kt,[s(b,{"content-position":"left"},{default:l(()=>t[9]||(t[9]=[a("h3",{class:"text-lg font-semibold"},"关联发票及收款情况",-1)])),_:1,__:[9]}),a("div",Dt,[a("div",Mt,[t[10]||(t[10]=a("div",{class:"stat-label"},"发票总数",-1)),a("div",Et,r(h.value.totalCount),1)]),a("div",St,[t[11]||(t[11]=a("div",{class:"stat-label"},"发票总额",-1)),a("div",Tt,"¥"+r(p(h.value.totalAmount)),1)]),a("div",Ft,[t[12]||(t[12]=a("div",{class:"stat-label"},"未开票总额",-1)),a("div",It,"¥"+r(p(h.value.uninvoicedAmount)),1)]),a("div",Ut,[t[13]||(t[13]=a("div",{class:"stat-label"},"已收款",-1)),a("div",Bt,"¥"+r(p(h.value.paidAmount)),1)]),a("div",qt,[t[14]||(t[14]=a("div",{class:"stat-label"},"未收款",-1)),a("div",Pt,"¥"+r(p(h.value.unpaidAmount)),1)])]),s(Q,{data:((R=d.value)==null?void 0:R.invoices)||[],border:"",style:{width:"100%"}},{default:l(()=>[s(c,{prop:"invoice_number",label:"发票编号",width:"150"}),s(c,{prop:"amount",label:"发票金额",width:"120"},{default:l(o=>[g(" ¥"+r(p(o.row.total_amount)),1)]),_:1}),s(c,{prop:"issue_date",label:"开票日期",width:"120"},{default:l(o=>[g(r(B(o.row.issue_date)),1)]),_:1}),s(c,{prop:"status",label:"发票状态",width:"100"},{default:l(o=>[s(E,{type:O(o.row.status)},{default:l(()=>[g(r(Y(o.row.status)),1)]),_:2},1032,["type"])]),_:1}),s(c,{label:"收款情况","min-width":"300"},{default:l(o=>[o.row.payments&&o.row.payments.length>0?(m(),v("div",Rt,[(m(!0),v(ct,null,mt(o.row.payments,_=>(m(),v("div",{key:_.id,class:"payment-item"},[a("div",zt,[a("div",Lt,[a("span",$t,"¥"+r(p(_.amount)),1),a("span",jt,r(B(_.payment_date)),1)]),a("div",Ot,[s(E,{size:"small",type:X(_.status)},{default:l(()=>[g(r(Z(_.status)),1)]),_:2},1032,["type"]),s(E,{size:"small",type:"info"},{default:l(()=>[g(r(G(_.payment_method)),1)]),_:2},1024)])]),_.reference_number?(m(),v("div",Yt," 参考号: "+r(_.reference_number),1)):z("",!0)]))),128)),a("div",Xt," 已收: ¥"+r(p(M(o.row)))+" / 未收: ¥"+r(p(o.row.total_amount-M(o.row))),1)])):(m(),v("div",Zt,"暂无收款记录"))]),_:1})]),_:1},8,["data"])])):f.value&&d.value&&(!d.value.invoices||d.value.invoices.length===0)?(m(),v("div",Gt,[s(b,{"content-position":"left"},{default:l(()=>t[15]||(t[15]=[a("h3",{class:"text-lg font-semibold"},"关联发票及收款情况",-1)])),_:1,__:[15]}),t[16]||(t[16]=a("div",{class:"text-center py-8 text-gray-500"},[a("p",null,"该合同暂无关联发票")],-1))])):z("",!0)])])}}});const _e=wt(Ht,[["__scopeId","data-v-8615e27a"]]);export{_e as default};
