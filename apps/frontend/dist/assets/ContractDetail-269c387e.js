/* empty css                  *//* empty css                   *//* empty css                        *//* empty css                    */import"./el-tooltip-4ed993c7.js";/* empty css                     *//* empty css               *//* empty css                             */import{d as Z,r as T,x as F,o as tt,c as m,b as a,e as o,w as n,N as et,L,M as w,t as l,h as at,i as st,n as y,v as ot,V as nt,R as lt,P as rt,l as u,g as r,X as ct,Y as it,W as ut,O as dt,U as mt}from"./index-2473cdd3.js";import{c as _t}from"./contract-51d9882f.js";import{F as pt,A as vt,a as P}from"./AttachmentList-eab5fe5a.js";import{_ as ft}from"./_plugin-vue_export-helper-c27b6911.js";/* empty css                   */const yt={class:"page-container"},ht={class:"page-header"},gt={style:{"white-space":"pre-wrap"}},bt={key:1,class:"mt-6"},wt={class:"stats-container"},At={class:"stat-card stat-card-blue"},Ct={class:"stat-value"},kt={class:"stat-card stat-card-green"},xt={class:"stat-value"},Mt={class:"stat-card stat-card-purple"},Nt={class:"stat-value"},Tt={key:0,class:"stat-action"},Dt={class:"stat-card stat-card-orange"},Et={class:"stat-value"},It={class:"stat-card stat-card-red"},St={class:"stat-value"},Bt={key:0},zt={class:"payment-header"},Ft={class:"payment-amount"},Lt={class:"amount-text"},Pt={class:"date-text"},Ut={class:"payment-tags"},Vt={key:0,class:"reference-number"},$t={key:1,class:"text-gray-500 text-sm mb-2"},Rt={class:"payment-summary"},Ot={key:2,class:"mt-6"},Wt={class:"text-center py-8 text-gray-500"},Xt={key:3,class:"mt-6"},Yt={class:"mb-4"},jt=Z({__name:"ContractDetail",setup(qt){const k=at(),U=st(),D=T(!1),s=T(),A=T([]),E=T(!1),h=F(()=>Number(U.params.id)),x=t=>{if(t==null||t==="")return 0;const e=Number(t);return isNaN(e)?0:e},g=F(()=>{var N;if(!((N=s.value)!=null&&N.invoices)||!Array.isArray(s.value.invoices))return{totalCount:0,totalAmount:0,paidAmount:0,unpaidAmount:0,uninvoicedAmount:s.value?x(s.value.total_amount):0};const t=s.value.invoices,e=x(s.value.total_amount),d=t.length,i=t.reduce((C,b)=>C+x(b.total_amount),0),v=t.reduce((C,b)=>C+M(b),0),S=i-v,f=e-i;return{totalCount:d,totalAmount:i,paidAmount:v,unpaidAmount:S,uninvoicedAmount:f}}),_=t=>new Intl.NumberFormat("zh-CN").format(t),I=t=>new Date(t).toLocaleString("zh-CN"),V=t=>({draft:"info",active:"success",completed:"primary",cancelled:"danger"})[t]||"info",$=t=>({draft:"草稿",active:"执行中",completed:"已完成",cancelled:"已取消"})[t]||t,R=t=>({draft:"info",sent:"warning",paid:"success",overdue:"danger",cancelled:"primary"})[t]||"info",O=t=>({draft:"草稿",sent:"已开票",paid:"已付款",overdue:"逾期",cancelled:"已取消"})[t]||t,W=t=>({pending:"warning",completed:"success",failed:"danger"})[t]||"info",X=t=>({pending:"待处理",completed:"已完成",failed:"失败"})[t]||t,Y=t=>({cash:"现金",bank_transfer:"银行转账",check:"支票",credit_card:"信用卡",other:"其他"})[t]||t,M=t=>!t.payments||!Array.isArray(t.payments)||t.payments.length===0?0:t.payments.filter(e=>e.status==="completed").reduce((e,d)=>e+x(d.amount),0),j=async()=>{try{D.value=!0;const t=await _t.getContractById(h.value);t.success&&t.data&&(s.value=t.data)}catch(t){console.error("Failed to fetch contract:",t),y.error("获取合同信息失败")}finally{D.value=!1}},q=()=>{k.push(`/contracts/${h.value}/edit`)},B=()=>{k.push(`/invoices/create?contractId=${h.value}`)},G=t=>{k.push(`/payments/create?invoiceId=${t}`)},H=()=>{k.go(-1)},z=async()=>{try{E.value=!0;const t=await P.getContractAttachments(h.value);t.success&&t.data&&(A.value=t.data)}catch(t){console.error("Failed to fetch attachments:",t),y.error("获取附件列表失败")}finally{E.value=!1}},J=t=>{A.value.unshift(t),y.success("附件上传成功")},K=t=>{console.error("Upload error:",t),y.error("附件上传失败")},Q=async t=>{try{const e=await P.deleteContractAttachment(h.value,t);e.success?(A.value=A.value.filter(d=>d.attachment_id!==t),y.success("附件删除成功")):y.error(e.message||"删除失败")}catch(e){console.error("Delete error:",e),y.error("删除附件失败")}};return tt(()=>{j(),z()}),(t,e)=>{var b;const d=ot,i=ut,v=dt,S=nt,f=mt,N=lt,C=rt;return u(),m("div",yt,[a("div",ht,[e[2]||(e[2]=a("h2",{class:"page-title"},"合同详情",-1)),a("div",null,[o(d,{onClick:H},{default:n(()=>e[0]||(e[0]=[r("返回")])),_:1,__:[0]}),o(d,{type:"primary",onClick:q},{default:n(()=>e[1]||(e[1]=[r("编辑")])),_:1,__:[1]})])]),et((u(),m("div",null,[s.value?(u(),L(S,{key:0,column:2,border:""},{default:n(()=>[o(i,{label:"合同编号"},{default:n(()=>[r(l(s.value.contract_number),1)]),_:1}),o(i,{label:"合同标题"},{default:n(()=>[r(l(s.value.title),1)]),_:1}),o(i,{label:"客户名称"},{default:n(()=>{var c;return[r(l(((c=s.value.customer)==null?void 0:c.name)||"-"),1)]}),_:1}),o(i,{label:"合同金额"},{default:n(()=>[r("¥"+l(_(s.value.total_amount)),1)]),_:1}),o(i,{label:"开始日期"},{default:n(()=>[r(l(s.value.start_date),1)]),_:1}),o(i,{label:"结束日期"},{default:n(()=>[r(l(s.value.end_date),1)]),_:1}),o(i,{label:"状态"},{default:n(()=>[o(v,{type:V(s.value.status)},{default:n(()=>[r(l($(s.value.status)),1)]),_:1},8,["type"])]),_:1}),o(i,{label:"创建时间"},{default:n(()=>[r(l(I(s.value.created_at)),1)]),_:1}),o(i,{label:"合同描述",span:2},{default:n(()=>[r(l(s.value.description||"-"),1)]),_:1}),o(i,{label:"合同条款",span:2},{default:n(()=>[a("div",gt,l(s.value.terms||"-"),1)]),_:1}),o(i,{label:"备注",span:2},{default:n(()=>[r(l(s.value.notes||"-"),1)]),_:1})]),_:1})):w("",!0),s.value&&s.value.invoices&&s.value.invoices.length>0?(u(),m("div",bt,[e[10]||(e[10]=a("h3",{class:"text-lg font-semibold mb-4"},"关联发票及收款情况",-1)),a("div",wt,[a("div",At,[e[3]||(e[3]=a("div",{class:"stat-label"},"发票总数",-1)),a("div",Ct,l(g.value.totalCount),1)]),a("div",kt,[e[4]||(e[4]=a("div",{class:"stat-label"},"发票总额",-1)),a("div",xt,"¥"+l(_(g.value.totalAmount)),1)]),a("div",Mt,[e[6]||(e[6]=a("div",{class:"stat-label"},"未开票总额",-1)),a("div",Nt,"¥"+l(_(g.value.uninvoicedAmount)),1),g.value.uninvoicedAmount>0?(u(),m("div",Tt,[o(d,{type:"primary",size:"small",onClick:B,class:"action-button"},{default:n(()=>e[5]||(e[5]=[r(" 去开票 ")])),_:1,__:[5]})])):w("",!0)]),a("div",Dt,[e[7]||(e[7]=a("div",{class:"stat-label"},"已收款",-1)),a("div",Et,"¥"+l(_(g.value.paidAmount)),1)]),a("div",It,[e[8]||(e[8]=a("div",{class:"stat-label"},"未收款",-1)),a("div",St,"¥"+l(_(g.value.unpaidAmount)),1)])]),o(N,{data:((b=s.value)==null?void 0:b.invoices)||[],border:"",style:{width:"100%"}},{default:n(()=>[o(f,{prop:"invoice_number",label:"发票编号",width:"150"}),o(f,{prop:"amount",label:"发票金额",width:"120"},{default:n(c=>[r(" ¥"+l(_(c.row.total_amount)),1)]),_:1}),o(f,{prop:"issue_date",label:"开票日期",width:"120"},{default:n(c=>[r(l(I(c.row.issue_date)),1)]),_:1}),o(f,{prop:"status",label:"发票状态",width:"100"},{default:n(c=>[o(v,{type:R(c.row.status)},{default:n(()=>[r(l(O(c.row.status)),1)]),_:2},1032,["type"])]),_:1}),o(f,{label:"收款情况","min-width":"300"},{default:n(c=>[a("div",null,[c.row.payments&&c.row.payments.length>0?(u(),m("div",Bt,[(u(!0),m(ct,null,it(c.row.payments,p=>(u(),m("div",{key:p.id,class:"payment-item"},[a("div",zt,[a("div",Ft,[a("span",Lt,"¥"+l(_(p.amount)),1),a("span",Pt,l(I(p.payment_date)),1)]),a("div",Ut,[o(v,{size:"small",type:W(p.status)},{default:n(()=>[r(l(X(p.status)),1)]),_:2},1032,["type"]),o(v,{size:"small",type:"info"},{default:n(()=>[r(l(Y(p.payment_method)),1)]),_:2},1024)])]),p.reference_number?(u(),m("div",Vt," 参考号: "+l(p.reference_number),1)):w("",!0)]))),128))])):(u(),m("div",$t,"暂无收款记录")),a("div",Rt,[r(" 已收: ¥"+l(_(M(c.row)))+" / 未收: ¥"+l(_(c.row.total_amount-M(c.row)))+" ",1),c.row.total_amount-M(c.row)>0?(u(),L(d,{key:0,type:"primary",size:"small",onClick:p=>G(c.row.id),class:"ml-2"},{default:n(()=>e[9]||(e[9]=[r(" 去收款 ")])),_:2,__:[9]},1032,["onClick"])):w("",!0)])])]),_:1})]),_:1},8,["data"])])):s.value&&(!s.value.invoices||s.value.invoices.length===0)?(u(),m("div",Ot,[e[13]||(e[13]=a("h3",{class:"text-lg font-semibold mb-4"},"关联发票及收款情况",-1)),a("div",Wt,[e[12]||(e[12]=a("p",null,"该合同暂无关联发票",-1)),o(d,{type:"primary",onClick:B,class:"mt-4"},{default:n(()=>e[11]||(e[11]=[r(" 立即开票 ")])),_:1,__:[11]})])])):w("",!0),s.value?(u(),m("div",Xt,[e[14]||(e[14]=a("h3",{class:"text-lg font-semibold mb-4"},"合同附件",-1)),a("div",Yt,[o(pt,{"upload-url":`/api/v1/contracts/${h.value}/attachments`,onSuccess:J,onError:K},null,8,["upload-url"])]),o(vt,{attachments:A.value,loading:E.value,onDelete:Q,onRefresh:z},null,8,["attachments","loading"])])):w("",!0)])),[[C,D.value]])])}}});const re=ft(jt,[["__scopeId","data-v-7e89a1a3"]]);export{re as default};
