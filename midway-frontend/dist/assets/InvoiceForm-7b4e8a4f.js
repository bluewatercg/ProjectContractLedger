/* empty css                  *//* empty css                   *//* empty css                     *//* empty css                 *//* empty css                        *//* empty css                     */import{d as M,r as f,x as d,a as $,o as L,c as P,b as c,t as C,N as Y,L as j,w as n,h as O,i as X,n as D,E as z,P as G,l as E,e as o,g as I,q as H,X as J,Y as K,p as Q,v as W}from"./index-1e642474.js";import{i as v}from"./invoice-657a2ee3.js";import{C as Z}from"./ContractSelect-051d8073.js";/* empty css               *//* empty css                  */import"./contract-f9d1be3d.js";import"./_plugin-vue_export-helper-c27b6911.js";const ee={class:"page-container"},te={class:"page-header"},ae={class:"page-title"},oe={class:"form-container"},le={class:"form-actions"},be=M({__name:"InvoiceForm",setup(ne){const g=O(),h=X(),m=f(),p=f(!1),u=f(!1),i=d(()=>!!h.params.id),b=d(()=>Number(h.params.id)),t=$({contract_id:0,amount:0,tax_rate:0,issue_date:"",description:"",notes:""}),y=d(()=>t.amount*(t.tax_rate||0)/100),N=d(()=>t.amount+y.value),k={contract_id:[{required:!0,message:"请选择合同",trigger:"change"}],amount:[{required:!0,message:"请输入发票金额",trigger:"blur"}],issue_date:[{required:!0,message:"请选择开票日期",trigger:"change"}]},B=(a,e)=>{t.contract_id=a||0,console.log("Selected contract:",e)},V=()=>{},S=a=>{if(!a)return"";const e=new Date(a);if(isNaN(e.getTime()))return"";const s=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),_=String(e.getDate()).padStart(2,"0");return`${s}-${r}-${_}`},F=a=>{if(!a)return null;const e=new Date(a);return isNaN(e.getTime())?null:e},U=async()=>{if(i.value)try{p.value=!0;const a=await v.getInvoiceById(b.value);if(a.success&&a.data){const e=a.data;Object.assign(t,{...e,issue_date:F(e.issue_date)})}}catch(a){console.error("Failed to fetch invoice:",a),D.error("获取发票信息失败")}finally{p.value=!1}},q=async()=>{if(m.value)try{await m.value.validate(),u.value=!0;const a={...t,issue_date:S(t.issue_date)};let e;i.value?e=await v.updateInvoice(b.value,a):e=await v.createInvoice(a),e.success&&(D.success(i.value?"更新成功":"创建成功"),g.push("/invoices"))}catch(a){console.error("Failed to submit form:",a)}finally{u.value=!1}},R=()=>{g.go(-1)};return L(()=>{i.value&&U()}),(a,e)=>{const s=H,r=J,_=K,w=Q,x=W,T=z,A=G;return E(),P("div",ee,[c("div",te,[c("h2",ae,C(i.value?"编辑发票":"新建发票"),1)]),c("div",oe,[Y((E(),j(T,{ref_key:"formRef",ref:m,model:t,rules:k,"label-width":"100px"},{default:n(()=>[o(s,{label:"合同",prop:"contract_id"},{default:n(()=>[o(Z,{modelValue:t.contract_id,"onUpdate:modelValue":e[0]||(e[0]=l=>t.contract_id=l),placeholder:"请选择合同（支持搜索）",onChange:B},null,8,["modelValue"])]),_:1}),o(s,{label:"发票金额",prop:"amount"},{default:n(()=>[o(r,{modelValue:t.amount,"onUpdate:modelValue":e[1]||(e[1]=l=>t.amount=l),min:0,precision:2,style:{width:"100%"},placeholder:"请输入发票金额",onChange:V},null,8,["modelValue"])]),_:1}),o(s,{label:"税率(%)",prop:"tax_rate"},{default:n(()=>[o(r,{modelValue:t.tax_rate,"onUpdate:modelValue":e[2]||(e[2]=l=>t.tax_rate=l),min:0,max:100,precision:2,style:{width:"100%"},placeholder:"请输入税率",onChange:V},null,8,["modelValue"])]),_:1}),o(s,{label:"税额"},{default:n(()=>[o(r,{"model-value":y.value,disabled:"",precision:2,style:{width:"100%"}},null,8,["model-value"])]),_:1}),o(s,{label:"总金额"},{default:n(()=>[o(r,{"model-value":N.value,disabled:"",precision:2,style:{width:"100%"}},null,8,["model-value"])]),_:1}),o(s,{label:"开票日期",prop:"issue_date"},{default:n(()=>[o(_,{modelValue:t.issue_date,"onUpdate:modelValue":e[3]||(e[3]=l=>t.issue_date=l),type:"date",placeholder:"请选择开票日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),o(s,{label:"发票描述",prop:"description"},{default:n(()=>[o(w,{modelValue:t.description,"onUpdate:modelValue":e[4]||(e[4]=l=>t.description=l),type:"textarea",rows:4,placeholder:"请输入发票描述"},null,8,["modelValue"])]),_:1}),o(s,{label:"备注",prop:"notes"},{default:n(()=>[o(w,{modelValue:t.notes,"onUpdate:modelValue":e[5]||(e[5]=l=>t.notes=l),type:"textarea",rows:4,placeholder:"请输入备注信息"},null,8,["modelValue"])]),_:1}),c("div",le,[o(x,{onClick:R},{default:n(()=>e[6]||(e[6]=[I("取消")])),_:1,__:[6]}),o(x,{type:"primary",loading:u.value,onClick:q},{default:n(()=>[I(C(u.value?"保存中...":"保存"),1)]),_:1},8,["loading"])])]),_:1},8,["model"])),[[A,p.value]])])])}}});export{be as default};
